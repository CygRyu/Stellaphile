<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Bibliophile: Reading Strategy Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#34D399',
                        cosmic: '#805AD5',
                        danger: '#F87171',
                        warning: '#FBBF24',
                        info: '#60A5FA',
                        enlightenment: '#FF6B6B',
                        galaxy: '#4F46E5',
                        dark: {
                            bg: '#181818',
                            card: '#252525',
                            text: '#E5E5E5'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'space-twinkle': 'twinkle 3s ease-in-out infinite alternate'
                    },
                    keyframes: {
                        glow: {
                            '0%': { textShadow: '0 0 2px #fff, 0 0 4px #fff, 0 0 6px #FF6B6B, 0 0 8px #FF6B6B' },
                            '100%': { textShadow: '0 0 4px #fff, 0 0 6px #FF9B9B, 0 0 8px #FF9B9B, 0 0 10px #FF9B9B' }
                        },
                        twinkle: {
                            '0%': { opacity: '0.5' },
                            '50%': { opacity: '1' },
                            '100%': { opacity: '0.7' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .resource-icon {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        /* Progress bar animations */
        @keyframes progress {
            from { width: 0%; }
            to { width: 100%; }
        }
        
        .progress-animation {
            animation: progress 30s linear infinite;
        }
        
        /* Dark mode support */
        .dark .dark\:bg-dark-bg { background-color: #181818; }
        .dark .dark\:bg-dark-card { background-color: #252525; }
        .dark .dark\:text-dark-text { color: #E5E5E5; }
        .dark .dark\:border-gray-700 { border-color: #4B5563; }
        
        /* Tooltip styles */
        .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 6px;
            width: 200px;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent rgba(0, 0, 0, 0.8) transparent;
        }
        
        .tooltip-container:hover .tooltip {
            visibility: visible;
        }
        
        /* Enlightenment glow effect */
        .enlightenment-glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            0% { text-shadow: 0 0 2px #fff, 0 0 4px #fff, 0 0 6px #FF6B6B, 0 0 8px #FF6B6B; }
            100% { text-shadow: 0 0 4px #fff, 0 0 6px #FF9B9B, 0 0 8px #FF9B9B, 0 0 10px #FF9B9B; }
        }
        
        /* Galaxy map styling */
        .galaxy-map {
            position: relative;
            overflow: hidden;
            background-color: #070b19;
            border-radius: 8px;
        }
        
        .star {
            position: absolute;
            border-radius: 50%;
            background-color: white;
            box-shadow: 0 0 10px white, 0 0 15px #5D5CDE;
        }
        
        .star-system {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .star-system:hover {
            transform: scale(1.2);
        }
        
        .star-system.discovered {
            box-shadow: 0 0 10px white, 0 0 15px #5D5CDE;
        }
        
        .star-system.unexplored {
            opacity: 0.6;
            filter: grayscale(70%);
        }
        
        .exploration-radius {
            position: absolute;
            border: 2px dashed rgba(93, 92, 222, 0.4);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .star-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 6px;
            z-index: 20;
            min-width: 200px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        /* Galaxy controls */
        .galaxy-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 30px;
            backdrop-filter: blur(5px);
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        .galaxy-control-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(93, 92, 222, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .galaxy-control-btn:hover {
            background-color: rgba(93, 92, 222, 0.6);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg min-h-screen transition-colors duration-200">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-dark-text mb-2">Stellar Bibliophile</h1>
            <p class="text-gray-600 dark:text-gray-400">Reading Tracker with Grand Strategy Elements</p>
            <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">v1.3.0</div>
        </header>

        <!-- Resources Bar -->
        <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
            <div class="grid grid-cols-3 md:grid-cols-4 gap-2 md:gap-4">
                <div class="flex items-center">
                    <div class="resource-icon bg-blue-100 text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Knowledge Points</div>
                        <div class="font-bold text-gray-900 dark:text-dark-text"><span id="knowledge-points">0</span> KP</div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="resource-icon bg-purple-100 text-purple-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Research Points</div>
                        <div class="font-bold text-gray-900 dark:text-dark-text"><span id="research-points">0</span> RP</div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="resource-icon bg-yellow-100 text-yellow-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Influence</div>
                        <div class="font-bold text-gray-900 dark:text-dark-text"><span id="influence">0</span> INF</div>
                    </div>
                </div>
                <div id="enlightenment-container" class="flex items-center hidden">
                    <div class="resource-icon bg-red-100 text-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Enlightenment</div>
                        <div class="font-bold text-enlightenment"><span id="enlightenment-points">0</span> EP</div>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-xs text-gray-500 dark:text-gray-400 flex justify-between">
                <div>Level: <span id="player-level" class="font-medium">1</span></div>
                <div>Passive RP: <span id="passive-rp" class="font-medium">0</span>/min</div>
                <div>Books Read: <span id="books-read" class="font-medium">0</span></div>
                <div id="prestige-level-container" class="hidden">Prestige: <span id="prestige-level" class="font-medium">0</span></div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                <li class="mr-2">
                    <a href="#" class="tab-link active inline-block p-4 border-b-2 border-primary text-primary dark:text-primary rounded-t-lg" data-tab="reading">Reading Tracker</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="facilities">Facilities</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="research">Research</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="stats">Stats</a>
                </li>
                <li class="mr-2">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="galaxy">Galaxy</a>
                </li>
                <li id="enlightenment-tab-li" class="mr-2 hidden">
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg enlightenment-text" data-tab="enlightenment">Enlightenment</a>
                </li>
                <li>
                    <a href="#" class="tab-link inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg" data-tab="settings">Settings</a>
                </li>
            </ul>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Reading Tracker Tab -->
            <div id="reading-tab" class="tab-pane active">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Track Your Reading</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Book Title</label>
                        <input type="text" id="book-title" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base" placeholder="Enter book title">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Genre</label>
                            <select id="book-genre" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                                <option value="sci-fi">Science Fiction</option>
                                <option value="fantasy">Fantasy</option>
                                <option value="non-fiction">Non-Fiction</option>
                                <option value="mystery">Mystery/Thriller</option>
                                <option value="history">History</option>
                                <option value="science">Science</option>
                                <option value="biography">Biography</option>
                                <option value="custom">Other (Custom)</option>
                            </select>
                            <div id="custom-genre-container" class="mt-2 hidden">
                                <input type="text" id="custom-genre" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base" placeholder="Enter custom genre">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Difficulty</label>
                            <select id="book-difficulty" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                                <option value="easy">Easy (x1.0 KP)</option>
                                <option value="medium" selected>Medium (x1.5 KP)</option>
                                <option value="hard">Hard (x2.0 KP)</option>
                                <option value="expert">Expert (x3.0 KP)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pages Read</label>
                            <input type="number" id="pages-read" min="1" value="10" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reading Minutes</label>
                            <input type="number" id="reading-minutes" min="1" value="30" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base">
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="log-reading" class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200 flex-grow">
                            Log Reading Session
                        </button>
                        <button id="complete-book" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                            Complete Book
                        </button>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Current Reading</h2>
                    <div id="current-reading-list" class="space-y-3">
                        <div class="text-gray-500 dark:text-gray-400 text-center py-3">No current books. Start reading!</div>
                    </div>
                </div>
            </div>

            <!-- Facilities Tab -->
            <div id="facilities-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-2">Your Facilities</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm">Build and upgrade facilities to generate resources and unlock bonuses.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative" id="facilities-grid">
                        <!-- Research Center -->
                        <div id="facility-research-center" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative tooltip-container">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                </svg>
                                Research Center
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Generates research points over time.
                            </div>
                            <div class="space-y-2">
                                <div>
                                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                        <span>Level: <span id="research-center-level">0</span></span>
                                        <span>Output: <span id="research-center-output">0</span> RP/min</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-1 overflow-hidden">
                                        <div id="research-center-progress" class="bg-purple-600 h-2.5 rounded-full progress-animation" style="width: 0%"></div>
                                    </div>
                                </div>
                                <button id="build-research-center" class="w-full bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                    Build (50 KP)
                                </button>
                                <button id="upgrade-research-center" class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200 hidden">
                                    Upgrade to Level 1 (100 KP)
                                </button>
                            </div>
                            <div class="tooltip">
                                <div class="text-xs font-semibold mb-1">Research Center</div>
                                <div class="text-xs mb-2">The core of your scientific efforts, producing Research Points for new technologies.</div>
                            </div>
                        </div>
                        
                        <!-- Knowledge Repository -->
                        <div id="facility-knowledge-repository" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative tooltip-container">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
                                </svg>
                                Knowledge Repository
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Increases knowledge point gain from reading.
                            </div>
                            <div class="space-y-2">
                                <div>
                                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                        <span>Level: <span id="repository-level">0</span></span>
                                        <span>Bonus: <span id="repository-bonus">0</span>% KP gain</span>
                                    </div>
                                </div>
                                <button id="build-repository" class="w-full bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                    Build (100 KP, 20 RP)
                                </button>
                                <button id="upgrade-repository" class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200 hidden">
                                    Upgrade to Level 1 (200 KP, 40 RP)
                                </button>
                            </div>
                            <div class="tooltip">
                                <div class="text-xs font-semibold mb-1">Knowledge Repository</div>
                                <div class="text-xs mb-2">Stores and catalogs your accumulated knowledge, increasing KP gains.</div>
                            </div>
                        </div>
                        
                        <!-- Academy Complex -->
                        <div id="facility-academy-complex" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative tooltip-container">
                            <div class="absolute top-2 right-2 text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">Locked</div>
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                                Academy Complex
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Trains specialists to boost other facilities and unlock advanced capabilities.
                            </div>
                            <div class="space-y-2">
                                <div>
                                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                        <span>Requirements:</span>
                                    </div>
                                    <ul class="text-xs text-gray-500 dark:text-gray-400 list-disc list-inside mt-1">
                                        <li>Player Level 3</li>
                                        <li>Research Center Level 2</li>
                                    </ul>
                                </div>
                                <button id="build-academy" class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                    Locked
                                </button>
                            </div>
                            <div class="tooltip">
                                <div class="text-xs font-semibold mb-1">Academy Complex</div>
                                <div class="text-xs mb-2">Trains specialists who provide significant bonuses to your facilities.</div>
                                <div class="text-xs">
                                    <div class="font-semibold">Benefits:</div>
                                    <ul class="list-disc list-inside">
                                        <li>+12% Player XP from reading</li>
                                        <li>Grants access to specialist training</li>
                                        <li>Unlocks advanced research options</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Observatory -->
                        <div id="facility-observatory" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative tooltip-container">
                            <div class="absolute top-2 right-2 text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">Locked</div>
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Observatory
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Discovers new books and genres for bonuses. Increases Influence generation.
                            </div>
                            <div class="space-y-2">
                                <div>
                                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                        <span>Requirements:</span>
                                    </div>
                                    <ul class="text-xs text-gray-500 dark:text-gray-400 list-disc list-inside mt-1">
                                        <li>Player Level 2</li>
                                        <li>5 Books Completed</li>
                                    </ul>
                                </div>
                                <button id="build-observatory" class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                    Locked
                                </button>
                            </div>
                            <div class="tooltip">
                                <div class="text-xs font-semibold mb-1">Observatory</div>
                                <div class="text-xs mb-2">Scans for new literary connections and opportunities, boosting Influence.</div>
                                <div class="text-xs">
                                    <div class="font-semibold">Benefits:</div>
                                    <ul class="list-disc list-inside">
                                        <li>+15% Influence from completing books</li>
                                        <li>Daily chance to discover rare books</li>
                                        <li>Reveals specialized genre bonuses</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Virtual Library -->
                        <div id="facility-virtual-library" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 relative tooltip-container">
                            <div class="absolute top-2 right-2 text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">Locked</div>
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Virtual Library
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Digitizes your reading collection for advanced analysis and passive resource generation.
                            </div>
                            <div class="space-y-2">
                                <div>
                                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                        <span>Requirements:</span>
                                    </div>
                                    <ul class="text-xs text-gray-500 dark:text-gray-400 list-disc list-inside mt-1">
                                        <li>Player Level 4</li>
                                        <li>Knowledge Repository Level 3</li>
                                        <li>15 Books Completed</li>
                                    </ul>
                                </div>
                                <button id="build-virtual-library" class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                    Locked
                                </button>
                            </div>
                            <div class="tooltip">
                                <div class="text-xs font-semibold mb-1">Virtual Library</div>
                                <div class="text-xs mb-2">Creates a digital repository of all your books, enabling powerful analytics.</div>
                                <div class="text-xs">
                                    <div class="font-semibold">Benefits:</div>
                                    <ul class="list-disc list-inside">
                                        <li>Generate all resources passively based on books read</li>
                                        <li>Unlocks genre specialization paths</li>
                                        <li>Enables advanced facility configurations</li>
                                        <li>+20% offline progression</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Research Tab -->
            <div id="research-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-2">Research Technologies</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm">Unlock upgrades and abilities through research.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Speed Reading -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text">Speed Reading</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                                Increases Knowledge Points gained per reading minute by 25%.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Cost: 50 RP</span>
                                <span>Status: <span id="speed-reading-status">Not Researched</span></span>
                            </div>
                            <button id="research-speed-reading" class="w-full bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Research
                            </button>
                        </div>
                        
                        <!-- Comprehension Algorithms -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text">Comprehension Algorithms</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                                Increases Knowledge Points by 20% for completing books.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Cost: 75 RP</span>
                                <span>Status: <span id="comprehension-status">Not Researched</span></span>
                            </div>
                            <button id="research-comprehension" class="w-full bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Research
                            </button>
                        </div>
                        
                        <!-- Advanced Construction -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text">Advanced Construction</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                                Reduces facility building costs by 15%.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Cost: 100 RP</span>
                                <span>Status: <span id="construction-status">Not Researched</span></span>
                            </div>
                            <button id="research-construction" class="w-full bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Research
                            </button>
                        </div>
                        
                        <!-- Automated Collection -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text">Automated Collection</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                                Increases offline resource generation by 50%.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Cost: 150 RP</span>
                                <span>Status: <span id="automation-status">Not Researched</span></span>
                            </div>
                            <button id="research-automation" class="w-full bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Research
                            </button>
                        </div>
                        
                        <!-- Facility Optimization -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text">Facility Optimization</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                                Increases all facility output and bonuses by 20%.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Cost: 200 RP</span>
                                <span>Status: <span id="optimization-status">Not Researched</span></span>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span class="font-semibold">Requirements:</span> Research Center Level 2
                            </div>
                            <button id="research-optimization" class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Research
                            </button>
                        </div>
                        
                        <!-- Stellar Cartography -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4" id="stellar-cartography-research">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text">Stellar Cartography</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                                Unlocks the Galaxy exploration system and reduces exploration costs by 20%.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Cost: 150 RP</span>
                                <span>Status: <span id="cartography-status">Not Researched</span></span>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span class="font-semibold">Requirements:</span> Observatory Level 1
                            </div>
                            <button id="research-cartography" class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Research
                            </button>
                        </div>
                        
                        <!-- Enlightenment Studies -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4" id="enlightenment-studies-research">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text">Enlightenment Studies</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 mb-3">
                                Prepares your mind for transcendence. Unlocks the Prestige system.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Cost: 500 RP</span>
                                <span>Status: <span id="enlightenment-status">Not Researched</span></span>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span class="font-semibold">Requirements:</span> Player Level 10, 25 Books Completed
                            </div>
                            <button id="research-enlightenment" class="w-full bg-gray-200 text-gray-500 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Research
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="stats-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Reading Statistics</h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-books">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Books Completed</div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-pages">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Pages Read</div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-minutes">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Reading Minutes</div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 text-center">
                            <div class="text-3xl font-bold text-primary"><span id="stat-total-kp">0</span></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">KP Generated</div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Genre Distribution</h3>
                    <div id="genre-distribution" class="space-y-3 mb-6">
                        <!-- Genre bars will be generated dynamically -->
                    </div>
                    
                    <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Achievements</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex items-center">
                            <div class="bg-gray-200 dark:bg-gray-700 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900 dark:text-dark-text">Bookworm</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Complete 5 books</div>
                                <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">Progress: <span id="bookworm-progress">0</span>/5</div>
                            </div>
                        </div>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 flex items-center">
                            <div class="bg-gray-200 dark:bg-gray-700 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900 dark:text-dark-text">Prolific Reader</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Read 1000 pages</div>
                                <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">Progress: <span id="prolific-progress">0</span>/1000</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prestige Stats Section -->
                    <div id="prestige-stats-section" class="mt-6 hidden">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-3">Prestige Statistics</h3>
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="lifetime-prestige">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total Prestiges</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="lifetime-ep">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total EP Earned</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="max-level">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Highest Level</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-enlightenment"><span id="max-books">0</span></div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Most Books Read</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Galaxy Tab -->
            <div id="galaxy-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text">Literary Galaxy</h2>
                        <div class="flex items-center">
                            <div class="resource-icon bg-yellow-100 text-yellow-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                </svg>
                            </div>
                            <span class="font-medium text-gray-700 dark:text-gray-300"><span id="galaxy-influence">0</span> INF</span>
                        </div>
                    </div>
                    
                    <div id="galaxy-unlock-message" class="py-8 text-center">
                        <div class="text-4xl mb-4"></div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Unlock the Literary Galaxy</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4 max-w-lg mx-auto">
                            Build the Observatory and research Stellar Cartography to explore the vast Literary Galaxy, discover star systems, and establish reading outposts for powerful bonuses.
                        </p>
                        <div class="flex flex-col space-y-2 max-w-xs mx-auto">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Observatory</span>
                                <span class="font-medium text-gray-900 dark:text-dark-text" id="galaxy-observatory-status">Not Built</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-400">Stellar Cartography</span>
                                <span class="font-medium text-gray-900 dark:text-dark-text" id="galaxy-cartography-status">Not Researched</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="galaxy-interface" class="hidden">
                        <div class="mb-4">
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">
                                Explore the Literary Galaxy to discover star systems and establish reading outposts. Each system provides unique bonuses to your reading journey.
                            </p>
                            
                            <div class="flex flex-wrap gap-4 mb-4">
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Systems Discovered</div>
                                    <div class="text-2xl font-bold text-galaxy" id="systems-discovered">0</div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Outposts Established</div>
                                    <div class="text-2xl font-bold text-galaxy" id="outposts-established">0</div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Exploration Range</div>
                                    <div class="text-2xl font-bold text-galaxy" id="exploration-range">3</div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Next System Cost</div>
                                    <div class="text-2xl font-bold text-galaxy" id="next-system-cost">25</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="galaxy-map-container">
                            <div class="galaxy-map w-full h-[400px] relative mb-4" id="galaxy-map">
                                <!-- Background stars (added via JS) -->
                                <!-- Star systems (added via JS) -->
                                <!-- Exploration radius visualization -->
                                <div class="exploration-radius" id="exploration-radius"></div>
                                
                                <!-- Galaxy map controls -->
                                <div class="galaxy-controls">
                                    <button class="galaxy-control-btn" id="zoom-in">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                        </svg>
                                    </button>
                                    <button class="galaxy-control-btn" id="zoom-out">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                                        </svg>
                                    </button>
                                    <button class="galaxy-control-btn" id="center-map">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                    <button class="galaxy-control-btn" id="explore-system">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <!-- Star system tooltip (shown when hovering over a system) -->
                                <div class="star-tooltip" id="star-tooltip"></div>
                            </div>
                        </div>
                        
                        <!-- Selected System Details Panel -->
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4 hidden" id="system-details-panel">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-bold text-gray-900 dark:text-dark-text" id="selected-system-name">System Name</h3>
                                <div class="text-sm px-2 py-1 rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200" id="selected-system-type">Star Type</div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2" id="selected-system-description">
                                        System description will appear here.
                                    </p>
                                    <div class="flex space-x-6 text-sm">
                                        <div>
                                            <span class="text-gray-500 dark:text-gray-400">Coordinates:</span>
                                            <span class="text-gray-700 dark:text-gray-300" id="selected-system-coordinates">(0, 0)</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 dark:text-gray-400">Planets:</span>
                                            <span class="text-gray-700 dark:text-gray-300" id="selected-system-planets">0</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 dark:text-gray-400">Rarity:</span>
                                            <span class="text-gray-700 dark:text-gray-300" id="selected-system-rarity">Common</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-end items-center">
                                    <button id="establish-outpost-btn" class="bg-galaxy hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Establish Outpost (25 INF)
                                    </button>
                                </div>
                            </div>
                            
                            <div class="border-t border-gray-200 dark:border-gray-700 pt-3">
                                <h4 class="font-medium text-gray-800 dark:text-gray-200 mb-2">Planets</h4>
                                <div id="system-planets-list" class="space-y-2">
                                    <!-- Planets will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expedition Status Panel -->
                        <div id="expedition-panel" class="bg-blue-50 dark:bg-blue-900 rounded-lg p-4 overflow-hidden hidden">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-medium text-blue-800 dark:text-blue-200">Expedition in Progress</h3>
                                <span class="text-sm text-blue-600 dark:text-blue-300" id="expedition-time">0:30</span>
                            </div>
                            <p class="text-sm text-blue-600 dark:text-blue-300 mb-2" id="expedition-message">
                                Your literary expedition is exploring the cosmos...
                            </p>
                            <div class="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-2 overflow-hidden">
                                <div id="expedition-progress" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Outposts Panel -->
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Active Reading Outposts</h2>
                    
                    <div id="no-outposts-message" class="py-8 text-center">
                        <p class="text-gray-600 dark:text-gray-400">
                            You haven't established any reading outposts yet. Explore the galaxy to find star systems and establish outposts.
                        </p>
                    </div>
                    
                    <div id="outposts-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <!-- Active outposts will be populated dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Enlightenment Tab -->
            <div id="enlightenment-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-enlightenment">Enlightenment</h2>
                        <div class="text-enlightenment font-bold">EP Available: <span id="available-ep">0</span></div>
                    </div>
                    
                    <p class="text-gray-600 dark:text-gray-400 mb-6 text-sm">Unlock permanent upgrades with Enlightenment Points. These bonuses persist through prestige resets.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Resource Production -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-enlightenment" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Resource Production
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Permanently increases all resource production rates.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Current bonus: <span id="resource-production-bonus">0</span>%</span>
                                <span>Cost: <span id="resource-production-cost">5</span> EP</span>
                            </div>
                            <button id="upgrade-resource-production" class="w-full bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Upgrade (+10% Production)
                            </button>
                        </div>
                        
                        <!-- Starting Resources -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-enlightenment" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                </svg>
                                Starting Resources
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Begin each prestige run with more resources.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Current bonus: <span id="starting-resources-bonus">0</span> KP / <span id="starting-rp-bonus">0</span> RP</span>
                                <span>Cost: <span id="starting-resources-cost">5</span> EP</span>
                            </div>
                            <button id="upgrade-starting-resources" class="w-full bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Upgrade (+25 KP, +10 RP)
                            </button>
                        </div>
                        
                        <!-- Reading Efficiency -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-enlightenment" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                                Reading Efficiency
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Permanently increases knowledge gained from reading.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Current bonus: <span id="reading-efficiency-bonus">0</span>%</span>
                                <span>Cost: <span id="reading-efficiency-cost">10</span> EP</span>
                            </div>
                            <button id="upgrade-reading-efficiency" class="w-full bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Upgrade (+15% Reading KP)
                            </button>
                        </div>
                        
                        <!-- Experience Boost -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-enlightenment" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Experience Boost
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Permanently increases experience gained from all sources.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Current bonus: <span id="experience-boost-bonus">0</span>%</span>
                                <span>Cost: <span id="experience-boost-cost">8</span> EP</span>
                            </div>
                            <button id="upgrade-experience-boost" class="w-full bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Upgrade (+12% XP Gain)
                            </button>
                        </div>
                        
                        <!-- Auto Research -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-enlightenment" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                Auto Research
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Start with automatic research of basic technologies.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Current level: <span id="auto-research-level">0</span>/5</span>
                                <span>Cost: <span id="auto-research-cost">15</span> EP</span>
                            </div>
                            <button id="upgrade-auto-research" class="w-full bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Upgrade (Unlock Auto Research)
                            </button>
                        </div>
                        
                        <!-- Facility Retention -->
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 dark:text-dark-text flex items-center">
                                <svg class="w-5 h-5 mr-2 text-enlightenment" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                Facility Retention
                            </h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-3">
                                Start with pre-built facilities after prestige.
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                                <span>Current level: <span id="facility-retention-level">0</span>/3</span>
                                <span>Cost: <span id="facility-retention-cost">20</span> EP</span>
                            </div>
                            <button id="upgrade-facility-retention" class="w-full bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Upgrade (Retain Research Center)
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-enlightenment mb-4">Ascension</h2>
                    
                    <div class="mb-6">
                        <p class="text-gray-600 dark:text-gray-400 mb-4">
                            Ascending will reset your progress, but reward you with Enlightenment Points (EP) based on your achievements. These points can be spent on permanent upgrades.
                        </p>
                        
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 mb-4">
                            <h3 class="font-bold text-gray-900 dark:text-white mb-2">Enlightenment Points Preview</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="flex flex-col">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">From Level:</span>
                                    <span class="text-lg font-bold text-enlightenment"><span id="ep-from-level">0</span> EP</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">From Books:</span>
                                    <span class="text-lg font-bold text-enlightenment"><span id="ep-from-books">0</span> EP</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">From Research:</span>
                                    <span class="text-lg font-bold text-enlightenment"><span id="ep-from-research">0</span> EP</span>
                                </div>
                            </div>
                            <div class="mt-4 text-center">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Total EP to be gained:</span>
                                <span class="text-2xl font-bold text-enlightenment ml-2"><span id="total-ep-gain">0</span> EP</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-center">
                            <button id="ascend-button" class="bg-enlightenment hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200 text-center flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                </svg>
                                Ascend
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-pane hidden">
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 mb-6 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Game Settings</h2>
                    
                    <div class="space-y-6">
                        <!-- Save/Load Game -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Save/Load Game</h3>
                            <div class="space-y-3">
                                <div>
                                    <button id="export-save" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Export Save Data
                                    </button>
                                    <button id="copy-save" class="ml-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                        Copy to Clipboard
                                    </button>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Import Save Data</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="import-save-data" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-base" placeholder="Paste save data here">
                                        <button id="import-save" class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                            Import
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prestige Section -->
                        <div id="prestige-settings-section" class="hidden">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Prestige</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">You can ascend to gain Enlightenment Points. This will reset your progress but unlock permanent bonuses.</p>
                            <button id="prestige-button" class="bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Ascend for Enlightenment Points
                            </button>
                        </div>
                        
                        <!-- Reset Game -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Reset Game</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">This will reset all progress. Make sure to export your save first!</p>
                            <button id="reset-game" class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Reset All Progress
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- About & Support -->
                <div class="bg-white dark:bg-dark-card rounded-lg shadow-md p-4 transition-colors duration-200">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">About & Support</h2>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">About Stellar Bibliophile</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Stellar Bibliophile v1.4.0 is a reading tracker with grand strategy elements. Track your reading progress, earn resources, build facilities, research technologies, and ascend for permanent bonuses.
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-dark-text mb-2">Support Development</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                            If you enjoy Stellar Bibliophile, consider supporting its development:
                        </p>
                        <div class="flex space-x-2">
                            <a href="https://ko-fi.com/cygryu" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Support on Ko-Fi
                            </a>
                            <a href="https://www.paypal.com/paypalme/sofiansu?country.x=ID&locale.x=en_US" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                                Donate via PayPal
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-8 text-center text-xs text-gray-500 dark:text-gray-500 py-4">
            <p>Stellar Bibliophile v1.4.0 | Developed by CygRyu</p>
            <p class="mt-1">Track your reading journey with strategic gameplay elements</p>
        </footer>
        
        <!-- Notification Area -->
        <div id="notification-area" class="fixed bottom-4 right-4 max-w-sm"></div>
        
        <!-- Save Data Export Modal -->
        <div id="save-export-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4">
                <h3 class="text-xl font-bold text-gray-900 dark:text-dark-text mb-4">Export Game Save</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                    Copy the text below to save your game progress. You can import this later to restore your game.
                </p>
                <textarea id="export-save-text" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-md text-xs font-mono" rows="5" readonly></textarea>
                <div class="flex justify-end mt-4 space-x-2">
                    <button id="copy-save-modal" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Copy to Clipboard
                    </button>
                    <button id="close-export-modal" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Close
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Ascension Confirmation Modal -->
        <div id="ascension-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4">
                <h3 class="text-xl font-bold text-enlightenment mb-4">Confirm Ascension</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                    You are about to ascend and reset your progress. You will gain <span id="confirm-ep-gain" class="font-bold text-enlightenment">0</span> Enlightenment Points.
                </p>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                    The following will be RESET:
                </p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 mb-4">
                    <li>Player level and all resources</li>
                    <li>All facilities and their levels</li>
                    <li>All research (except Enlightenment Studies)</li>
                    <li>Current books and reading progress</li>
                </ul>
                <p class="text-gray-600 dark:text-gray-400 mb-6">
                    The following will be KEPT:
                </p>
                <ul class="list-disc list-inside text-gray-600 dark:text-gray-400 mb-6">
                    <li>Enlightenment Points and all permanent upgrades</li>
                    <li>Lifetime statistics and achievements</li>
                    <li>Prestige level and unlocked features</li>
                </ul>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-ascension" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="confirm-ascension" class="bg-enlightenment hover:bg-red-600 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Ascend
                    </button>
                </div>
            </div>
        </div>
        
        <!-- System Discovery Modal -->
        <div id="discovery-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-dark-card rounded-lg shadow-lg p-6 max-w-lg w-full mx-4 text-center">
                <div class="text-4xl mb-2"></div>
                <h3 class="text-xl font-bold text-galaxy mb-3">New Star System Discovered!</h3>
                <h4 class="text-lg font-bold text-gray-900 dark:text-dark-text mb-4" id="discovered-system-name">System Name</h4>
                <p class="text-gray-600 dark:text-gray-400 mb-6" id="discovered-system-description">
                    System description will appear here.
                </p>
                <div class="flex justify-center space-x-4 text-sm text-gray-600 dark:text-gray-400 mb-6">
                    <div>
                        <span class="font-medium">Type:</span>
                        <span id="discovered-system-type">Unknown</span>
                    </div>
                    <div>
                        <span class="font-medium">Planets:</span>
                        <span id="discovered-system-planets">0</span>
                    </div>
                    <div>
                        <span class="font-medium">Rarity:</span>
                        <span id="discovered-system-rarity">Common</span>
                    </div>
                </div>
                <button id="close-discovery-modal" class="bg-galaxy hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Explore System
                </button>
            </div>
        </div>
    </div>

    <script>
        // Game version
        const GAME_VERSION = "1.4.0";
        
        // Check for dark mode preference
        function checkDarkMode() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
        }
        
        checkDarkMode();
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Game state
        const gameState = {
            version: GAME_VERSION,
            player: {
                level: 1,
                experiencePoints: 0,
                experienceToNextLevel: 100
            },
            resources: {
                knowledgePoints: 50,
                researchPoints: 0,
                influence: 0
            },
            facilities: {
                researchCenter: {
                    level: 0,
                    built: false,
                    output: 0,
                    cost: 50,
                    upgradeCost: 100
                },
                knowledgeRepository: {
                    level: 0,
                    built: false,
                    bonus: 0,
                    cost: 100,
                    rpCost: 20,
                    upgradeCost: 200,
                    upgradeRpCost: 40
                },
                academyComplex: {
                    level: 0,
                    built: false,
                    bonus: 0,
                    cost: 300,
                    rpCost: 100,
                    upgradeCost: 500,
                    upgradeRpCost: 150,
                    prerequisites: {
                        playerLevel: 3,
                        researchCenterLevel: 2
                    }
                },
                observatory: {
                    level: 0,
                    built: false,
                    bonus: 0,
                    cost: 200,
                    rpCost: 50,
                    upgradeCost: 350,
                    upgradeRpCost: 100,
                    prerequisites: {
                        playerLevel: 2,
                        booksCompleted: 5
                    }
                },
                virtualLibrary: {
                    level: 0,
                    built: false,
                    bonus: 0,
                    cost: 500,
                    rpCost: 200,
                    upgradeCost: 800,
                    upgradeRpCost: 300,
                    prerequisites: {
                        playerLevel: 4,
                        knowledgeRepositoryLevel: 3,
                        booksCompleted: 15
                    }
                }
            },
            research: {
                speedReading: false,
                comprehensionAlgorithms: false,
                advancedConstruction: false,
                automatedCollection: false,
                facilityOptimization: false,
                enlightenmentStudies: false,
                stellarCartography: false
            },
            stats: {
                booksCompleted: 0,
                pagesRead: 0,
                minutesRead: 0,
                totalKpGenerated: 0,
                genreDistribution: {
                    'sci-fi': 0,
                    'fantasy': 0,
                    'non-fiction': 0,
                    'mystery': 0,
                    'history': 0,
                    'science': 0,
                    'biography': 0,
                    'custom': {}
                }
            },
            currentBooks: [],
            // New prestige-related properties
            prestige: {
                unlocked: false,
                level: 0,
                enlightenmentPoints: 0,
                totalEnlightenmentEarned: 0,
                // Permanent upgrades that persist across prestige resets
                permanentUpgrades: {
                    resourceProduction: {
                        level: 0,
                        bonus: 0, // Percentage boost to all resource production
                        cost: 5,  // Base cost in EP
                        increment: 10 // Each level gives +10% production
                    },
                    startingResources: {
                        level: 0,
                        kpBonus: 0,   // Additional starting KP
                        rpBonus: 0,   // Additional starting RP
                        cost: 5,      // Base cost in EP
                        kpIncrement: 25, // Each level gives +25 starting KP
                        rpIncrement: 10  // Each level gives +10 starting RP
                    },
                    readingEfficiency: {
                        level: 0,
                        bonus: 0,   // Percentage boost to KP from reading
                        cost: 10,   // Base cost in EP
                        increment: 15 // Each level gives +15% reading efficiency
                    },
                    experienceBoost: {
                        level: 0,
                        bonus: 0,   // Percentage boost to XP gains
                        cost: 8,    // Base cost in EP
                        increment: 12 // Each level gives +12% XP
                    },
                    autoResearch: {
                        level: 0,
                        cost: 15,
                        maxLevel: 5 // Maximum of 5 auto researches
                        // Level 1: Speed Reading
                        // Level 2: Comprehension Algorithms
                        // Level 3: Advanced Construction
                        // Level 4: Automated Collection
                        // Level 5: Facility Optimization
                    },
                    facilityRetention: {
                        level: 0,
                        cost: 20,
                        maxLevel: 3
                        // Level 1: Start with Research Center
                        // Level 2: Start with Knowledge Repository
                        // Level 3: Start with Observatory
                    }
                }
            },
            // Lifetime stats that persist across prestiges
            lifetimeStats: {
                totalPrestiges: 0,
                maxLevel: 1,
                maxBooks: 0,
                totalEnlightenmentPoints: 0
            },
            // Galaxy exploration system data
            galaxy: {
                unlocked: false,
                discoveredSystems: {},
                currentCoordinates: { x: 0, y: 0 },
                viewCenter: { x: 0, y: 0 },
                explorationRange: 3,
                zoomLevel: 1,
                nextSystemCost: 25,
                systemCosts: {
                    base: 25,
                    distanceMultiplier: 1.2
                },
                activePlanets: [], // List of planets providing bonuses
                activeExpedition: null,
                stats: {
                    systemsDiscovered: 0,
                    outpostsEstablished: 0,
                    planetsColonized: 0,
                    expeditionsCompleted: 0,
                    rarePlanetsFound: 0
                }
            }
        };
        
        // Multipliers and game balance
        const gameSettings = {
            baseKpPerPage: 1,
            baseKpPerMinute: 0.5,
            difficultyMultipliers: {
                'easy': 1.0,
                'medium': 1.5,
                'hard': 2.0,
                'expert': 3.0
            },
            completionBonus: 0.2, // 20% bonus for completing a book
            resourceInterval: 30000, // Generate resources every 30 seconds
            facilityOptimizationBonus: 0.2, // +20% facility output when researched
            enlightenmentUnlocked: false, // Will be set to true when the Enlightenment Studies is researched
            
            // Galaxy exploration settings
            galaxy: {
                systemColors: {
                    classic: "#FFD700", // Yellow - Classical literature
                    academic: "#FFFFFF", // White - Academic literature
                    modern: "#60A5FA", // Blue - Modern literature
                    experimental: "#F87171", // Red - Experimental literature
                    speculative: "#34D399" // Green - Speculative fiction
                },
                rarityColors: {
                    common: "#FFFFFF",
                    uncommon: "#34D399",
                    rare: "#60A5FA",
                    legendary: "#805AD5",
                    mythic: "#F87171"
                },
                starSizesByRarity: {
                    common: 4,
                    uncommon: 6,
                    rare: 8,
                    legendary: 10,
                    mythic: 12
                },
                systemTypes: [
                    "classic", "academic", "modern", "experimental", "speculative"
                ],
                systemRarities: [
                    { rarity: "common", weight: 60 },
                    { rarity: "uncommon", weight: 25 },
                    { rarity: "rare", weight: 10 },
                    { rarity: "legendary", weight: 4 },
                    { rarity: "mythic", weight: 1 }
                ],
                planetNamePrefixes: [
                    "Nova", "Stellar", "Cosmo", "Astro", "Aether", "Nebula", "Pulsar", "Quasar", "Orbital",
                    "Helio", "Lunar", "Solar", "Celestial", "Cosmic", "Galactic", "Terran", "Vega", "Antares",
                    "Echo", "Lumina", "Aurora", "Zenith", "Meridian", "Horizon", "Infinity", "Parallax", "Apogee",
                    "Chronicle", "Saga", "Lexicon", "Compendium", "Atlas", "Opus", "Codex", "Grimoire", "Tome",
                    "Libri", "Volumen", "Bibliotheca", "Arcanum", "Memoria", "Enigma", "Paragon", "Literati", "Folio"
                ],
                planetNameSuffixes: [
                    "Prime", "Alpha", "Beta", "Gamma", "Major", "Minor", "Maxima", "Proxima", "Ultima",
                    "Core", "Centauri", "Terminus", "Nexus", "Locus", "Vertex", "Apex", "Nadir", "Primordial", 
                    "IX", "IV", "VI", "III", "II", "I", "VII", "VIII", "X",
                    "Archive", "Library", "Repository", "Compendium", "Collection", "Anthology", "Index", "Lexicon", "Chronicle"
                ],
                systemNamePatterns: [
                    "{prefix}",
                    "{prefix} {suffix}",
                    "{prefix}-{suffix}",
                    "{prefix} {number}",
                    "{prefix}-{number}",
                    "{letter}-{number}",
                    "{prefix} {letter}-{number}"
                ],
                baseTypeDescriptions: {
                    classic: "A traditional system with well-established planets, offering reliable bonuses to your reading journey.",
                    academic: "A scholarly system with knowledge-focused planets, increasing your research and understanding.",
                    modern: "A contemporary system with innovative planets, providing efficient and varied bonuses.",
                    experimental: "An avant-garde system with unconventional planets, offering unique and transformative bonuses.",
                    speculative: "A visionary system with imaginative planets, expanding possibilities with creative bonuses."
                },
                baseRarityDescriptions: {
                    common: "A typical star system with standard resources.",
                    uncommon: "A noteworthy system with above-average resources.",
                    rare: "A remarkable system with valuable and uncommon resources.",
                    legendary: "An extraordinary system with powerful, rare resources.",
                    mythic: "A legendary system with transformative, unique resources."
                },
                planetBonusTypes: [
                    { type: "kp_per_page", name: "KP per Page", desc: "{value}% increase to Knowledge Points per page", max: 15 },
                    { type: "kp_per_minute", name: "KP per Minute", desc: "{value}% increase to Knowledge Points per minute", max: 15 },
                    { type: "research_production", name: "Research Production", desc: "{value}% increase to Research Point generation", max: 20 },
                    { type: "influence_gain", name: "Influence Gain", desc: "{value}% increase to Influence gained from books", max: 20 },
                    { type: "xp_gain", name: "XP Gain", desc: "{value}% increase to Experience Points", max: 12 },
                    { type: "completion_bonus", name: "Completion Bonus", desc: "{value}% bonus when completing books", max: 25 },
                    { type: "passive_kp", name: "Passive KP", desc: "Generate {value} Knowledge Points per minute", max: 3 },
                    { type: "passive_rp", name: "Passive RP", desc: "Generate {value} Research Points per minute", max: 2 },
                    { type: "passive_inf", name: "Passive Influence", desc: "Generate {value} Influence per minute", max: 1 },
                    { type: "discovery_chance", name: "Discovery Chance", desc: "{value}% increased chance to discover new systems", max: 25 },
                    { type: "genre_bonus", name: "Genre Specialist", desc: "{value}% bonus for reading a specific genre", max: 30 }
                ]
            },
            
            // Prestige settings
            prestigeRequirements: {
                playerLevel: 10,
                booksCompleted: 25
            },
            // EP calculation factors
            epCalculation: {
                levelFactor: 0.5,     // Each level gives 0.5 EP
                bookFactor: 0.2,      // Each book gives 0.2 EP
                researchFactor: 1.0,   // Each research gives 1.0 EP
                facilityFactor: 0.5    // Each facility level gives 0.5 EP
            },
            // Genre colors for custom genres
            genreColors: [
                'blue-600',
                'purple-600',
                'green-600',
                'yellow-600',
                'red-600',
                'pink-600',
                'indigo-600',
                'teal-600',
                'orange-600'
            ]
        };
        
        // Tab navigation
        document.querySelectorAll('.tab-link').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Remove active class from all tabs
                document.querySelectorAll('.tab-link').forEach(t => {
                    t.classList.remove('active', 'border-primary', 'text-primary');
                    t.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                });
                
                // Add active class to clicked tab
                tab.classList.add('active', 'border-primary', 'text-primary');
                tab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                
                // Handle enlightenment tab specially
                if (tab.getAttribute('data-tab') === 'enlightenment') {
                    tab.classList.add('text-enlightenment');
                    tab.classList.remove('text-primary');
                    
                    // Update EP preview calculations
                    updateEpPreview();
                }
                
                // Update genre distribution if on stats tab
                if (tab.getAttribute('data-tab') === 'stats') {
                    updateGenreDistribution();
                }
                
                // Initialize galaxy map if on galaxy tab
                if (tab.getAttribute('data-tab') === 'galaxy') {
                    updateGalaxyUI();
                    if (gameState.galaxy.unlocked) {
                        initializeGalaxyMap();
                    }
                }
                
                // Hide all tab panes
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.add('hidden');
                    pane.classList.remove('active');
                });
                
                // Show the target tab pane
                const tabName = tab.getAttribute('data-tab');
                const tabPane = document.getElementById(tabName + '-tab');
                tabPane.classList.remove('hidden');
                tabPane.classList.add('active');
            });
        });
        
        // Custom Genre Selection
        document.getElementById('book-genre').addEventListener('change', function() {
            const customGenreContainer = document.getElementById('custom-genre-container');
            if (this.value === 'custom') {
                customGenreContainer.classList.remove('hidden');
            } else {
                customGenreContainer.classList.add('hidden');
            }
        });
        
        // Update UI with current game state
        function updateUI() {
            // Update resource displays
            document.getElementById('knowledge-points').textContent = Math.floor(gameState.resources.knowledgePoints);
            document.getElementById('research-points').textContent = Math.floor(gameState.resources.researchPoints);
            document.getElementById('influence').textContent = Math.floor(gameState.resources.influence);
            document.getElementById('galaxy-influence').textContent = Math.floor(gameState.resources.influence);
            
            // Update player stats
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('passive-rp').textContent = gameState.facilities.researchCenter.output;
            document.getElementById('books-read').textContent = gameState.stats.booksCompleted;
            
            // Update Galaxy UI component
            updateGalaxyUI();
            
            // Update prestige-related UI if unlocked
            if (gameState.prestige.unlocked) {
                // Show enlightenment points in resource bar
                document.getElementById('enlightenment-container').classList.remove('hidden');
                document.getElementById('enlightenment-points').textContent = gameState.prestige.enlightenmentPoints;
                
                // Show prestige level
                document.getElementById('prestige-level-container').classList.remove('hidden');
                document.getElementById('prestige-level').textContent = gameState.prestige.level;
                
                // Show enlightenment tab
                document.getElementById('enlightenment-tab-li').classList.remove('hidden');
                
                // Show prestige stats section
                document.getElementById('prestige-stats-section').classList.remove('hidden');
                document.getElementById('lifetime-prestige').textContent = gameState.lifetimeStats.totalPrestiges;
                document.getElementById('lifetime-ep').textContent = gameState.lifetimeStats.totalEnlightenmentPoints;
                document.getElementById('max-level').textContent = gameState.lifetimeStats.maxLevel;
                document.getElementById('max-books').textContent = gameState.lifetimeStats.maxBooks;
                
                // Show prestige button in settings
                document.getElementById('prestige-settings-section').classList.remove('hidden');
                
                // Update enlightenment tab content
                updateEnlightenmentUI();
            }
            
            // Update facility info
            document.getElementById('research-center-level').textContent = gameState.facilities.researchCenter.level;
            document.getElementById('research-center-output').textContent = gameState.facilities.researchCenter.output;
            document.getElementById('repository-level').textContent = gameState.facilities.knowledgeRepository.level;
            document.getElementById('repository-bonus').textContent = gameState.facilities.knowledgeRepository.bonus;
            
            // Update research status
            document.getElementById('speed-reading-status').textContent = gameState.research.speedReading ? 'Researched' : 'Not Researched';
            document.getElementById('comprehension-status').textContent = gameState.research.comprehensionAlgorithms ? 'Researched' : 'Not Researched';
            document.getElementById('construction-status').textContent = gameState.research.advancedConstruction ? 'Researched' : 'Not Researched';
            document.getElementById('automation-status').textContent = gameState.research.automatedCollection ? 'Researched' : 'Not Researched';
            document.getElementById('optimization-status').textContent = gameState.research.facilityOptimization ? 'Researched' : 'Not Researched';
            document.getElementById('cartography-status').textContent = gameState.research.stellarCartography ? 'Researched' : 'Not Researched';
            
            // Update galaxy observatory status
            document.getElementById('galaxy-observatory-status').textContent = gameState.facilities.observatory.built ? 'Built (Level ' + gameState.facilities.observatory.level + ')' : 'Not Built';
            document.getElementById('galaxy-cartography-status').textContent = gameState.research.stellarCartography ? 'Researched' : 'Not Researched';
            
            // Show/hide Stellar Cartography research based on requirements
            const stellarCartographyResearch = document.getElementById('stellar-cartography-research');
            if (stellarCartographyResearch) {
                if (gameState.facilities.observatory.built) {
                    stellarCartographyResearch.classList.remove('hidden');
                    
                    // Update button state
                    const researchBtn = document.getElementById('research-cartography');
                    if (gameState.research.stellarCartography) {
                        researchBtn.classList.add('bg-gray-200', 'text-gray-500');
                        researchBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                        researchBtn.textContent = 'Researched';
                    } else if (gameState.resources.researchPoints < 150) {
                        researchBtn.classList.add('bg-gray-200', 'text-gray-500');
                        researchBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    } else {
                        researchBtn.classList.remove('bg-gray-200', 'text-gray-500');
                        researchBtn.classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    }
                } else {
                    stellarCartographyResearch.classList.add('hidden');
                }
            }
            
            // Update enlightenment studies research status
            if (document.getElementById('enlightenment-status')) {
                document.getElementById('enlightenment-status').textContent = gameState.research.enlightenmentStudies ? 'Researched' : 'Not Researched';
            }
            
            // Show/hide enlightenment studies research based on requirements
            const enlightenmentStudiesResearch = document.getElementById('enlightenment-studies-research');
            if (enlightenmentStudiesResearch) {
                if (gameState.player.level >= gameSettings.prestigeRequirements.playerLevel &&
                    gameState.stats.booksCompleted >= gameSettings.prestigeRequirements.booksCompleted) {
                    enlightenmentStudiesResearch.classList.remove('hidden');
                    
                    // Update button state
                    const researchBtn = document.getElementById('research-enlightenment');
                    if (gameState.research.enlightenmentStudies) {
                        researchBtn.classList.add('bg-gray-200', 'text-gray-500');
                        researchBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                        researchBtn.textContent = 'Researched';
                    } else if (gameState.resources.researchPoints < 500) {
                        researchBtn.classList.add('bg-gray-200', 'text-gray-500');
                        researchBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    } else {
                        researchBtn.classList.remove('bg-gray-200', 'text-gray-500');
                        researchBtn.classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    }
                } else {
                    enlightenmentStudiesResearch.classList.add('hidden');
                }
            }
            
            // Update stats tab
            document.getElementById('stat-total-books').textContent = gameState.stats.booksCompleted;
            document.getElementById('stat-total-pages').textContent = gameState.stats.pagesRead;
            document.getElementById('stat-total-minutes').textContent = gameState.stats.minutesRead;
            document.getElementById('stat-total-kp').textContent = Math.floor(gameState.stats.totalKpGenerated);
            
            // Update genre distribution
            updateGenreDistribution();
            
            // Update achievement progress
            document.getElementById('bookworm-progress').textContent = Math.min(gameState.stats.booksCompleted, 5);
            document.getElementById('prolific-progress').textContent = Math.min(gameState.stats.pagesRead, 1000);
            
            // Update facility buttons
            updateFacilityButtons();
            updateResearchButtons();
            updateCurrentReadingList();
            
            // Check for new unlocks
            checkUnlocks();
        }
        
        // Update Galaxy UI
        function updateGalaxyUI() {
            // Update galaxy tab visibility based on unlock status
            if (gameState.galaxy.unlocked) {
                document.getElementById('galaxy-unlock-message').classList.add('hidden');
                document.getElementById('galaxy-interface').classList.remove('hidden');
                
                // Update galaxy stats
                document.getElementById('systems-discovered').textContent = gameState.galaxy.stats.systemsDiscovered;
                document.getElementById('outposts-established').textContent = gameState.galaxy.stats.outpostsEstablished;
                document.getElementById('exploration-range').textContent = gameState.galaxy.explorationRange;
                document.getElementById('next-system-cost').textContent = gameState.galaxy.nextSystemCost;
                
                // Update outposts list
                updateOutpostsList();
                
                // Update expedition status if there's an active expedition
                updateExpeditionStatus();
            } else {
                document.getElementById('galaxy-unlock-message').classList.remove('hidden');
                document.getElementById('galaxy-interface').classList.add('hidden');
                
                // Update unlock requirements
                document.getElementById('galaxy-observatory-status').textContent = gameState.facilities.observatory.built ? 'Built (Level ' + gameState.facilities.observatory.level + ')' : 'Not Built';
                document.getElementById('galaxy-cartography-status').textContent = gameState.research.stellarCartography ? 'Researched' : 'Not Researched';
            }
        }
        
        // Initialize Galaxy Map
        function initializeGalaxyMap() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            // Clear existing map elements
            mapContainer.innerHTML = '';
            
            // Create exploration radius indicator
            const radiusIndicator = document.createElement('div');
            radiusIndicator.id = 'exploration-radius';
            radiusIndicator.className = 'exploration-radius';
            mapContainer.appendChild(radiusIndicator);
            
            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.id = 'star-tooltip';
            tooltip.className = 'star-tooltip';
            mapContainer.appendChild(tooltip);
            
            // Create galaxy controls
            const controls = document.createElement('div');
            controls.className = 'galaxy-controls';
            controls.innerHTML = `
                <button class="galaxy-control-btn" id="zoom-in">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
                <button class="galaxy-control-btn" id="zoom-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                </button>
                <button class="galaxy-control-btn" id="center-map">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                </button>
                <button class="galaxy-control-btn" id="explore-system">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            `;
            mapContainer.appendChild(controls);
            
            // Add background stars
            addBackgroundStars();
            
            // Render known systems
            renderGalaxySystems();
            
            // Update exploration radius
            updateExplorationRadius();
            
            // Add event listeners for controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                zoomGalaxyMap(0.25); // Zoom in by 25%
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                zoomGalaxyMap(-0.25); // Zoom out by 25%
            });
            
            document.getElementById('center-map').addEventListener('click', () => {
                centerGalaxyMap();
            });
            
            document.getElementById('explore-system').addEventListener('click', () => {
                exploreRandomSystem();
            });
            
            // Add drag functionality to the map
            addMapDragFunctionality();
        }
        
        // Add background stars to the galaxy map
        function addBackgroundStars() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            const mapWidth = mapContainer.clientWidth;
            const mapHeight = mapContainer.clientHeight;
            
            // Generate between 50-100 stars based on map size
            const numStars = Math.floor(mapWidth * mapHeight / 1000);
            
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                // Random position
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                
                // Random size (0.5px to 2px)
                const size = 0.5 + Math.random() * 1.5;
                
                // Random opacity
                const opacity = 0.3 + Math.random() * 0.7;
                
                // Apply styles
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.opacity = opacity.toString();
                
                // Add animation with random delay
                star.style.animation = `twinkle 3s ease-in-out infinite alternate`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                
                mapContainer.appendChild(star);
            }
        }
        
        // Render star systems on the galaxy map
        function renderGalaxySystems() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            const mapWidth = mapContainer.clientWidth;
            const mapHeight = mapContainer.clientHeight;
            const centerX = mapWidth / 2;
            const centerY = mapHeight / 2;
            
            // Clear existing systems
            const existingSystems = mapContainer.querySelectorAll('.star-system');
            existingSystems.forEach(system => system.remove());
            
            // Calculate current view parameters
            const zoomFactor = gameState.galaxy.zoomLevel;
            const viewCenterX = gameState.galaxy.viewCenter.x;
            const viewCenterY = gameState.galaxy.viewCenter.y;
            
            // Add home system at center if it doesn't exist
            if (!gameState.galaxy.discoveredSystems['home']) {
                gameState.galaxy.discoveredSystems['home'] = {
                    id: 'home',
                    name: 'Home System',
                    coordinates: { x: 0, y: 0 },
                    type: 'classic',
                    rarity: 'uncommon',
                    discovered: true,
                    outpostEstablished: true,
                    description: 'Your home system, where your reading journey began.',
                    planets: [
                        {
                            id: 'home-prime',
                            name: 'Bibliotheca Prime',
                            colonized: true,
                            bonuses: [
                                { type: 'kp_per_page', value: 5 }
                            ],
                            description: 'Your starting world, providing a solid foundation for your reading empire.'
                        }
                    ]
                };
                gameState.galaxy.stats.systemsDiscovered = 1;
                gameState.galaxy.stats.outpostsEstablished = 1;
                gameState.galaxy.stats.planetsColonized = 1;
                
                // Add the home planet to active planets
                gameState.galaxy.activePlanets.push({
                    systemId: 'home',
                    planetId: 'home-prime',
                    systemName: 'Home System',
                    planetName: 'Bibliotheca Prime',
                    bonuses: [
                        { type: 'kp_per_page', value: 5 }
                    ]
                });
            }
            
            // Render each discovered system
            for (const systemId in gameState.galaxy.discoveredSystems) {
                const system = gameState.galaxy.discoveredSystems[systemId];
                
                // Calculate screen position
                const scaledX = (system.coordinates.x - viewCenterX) * zoomFactor * 50 + centerX;
                const scaledY = (system.coordinates.y - viewCenterY) * zoomFactor * 50 + centerY;
                
                // Skip if outside visible area with padding
                const padding = 50; // Pixels
                if (scaledX < -padding || scaledX > mapWidth + padding || 
                    scaledY < -padding || scaledY > mapHeight + padding) {
                    continue;
                }
                
                // Create system element
                const systemElement = document.createElement('div');
                systemElement.className = 'star-system';
                systemElement.dataset.systemId = systemId;
                
                // Set position and size based on rarity
                systemElement.style.left = `${scaledX}px`;
                systemElement.style.top = `${scaledY}px`;
                
                const size = gameSettings.galaxy.starSizesByRarity[system.rarity] * zoomFactor;
                systemElement.style.width = `${size}px`;
                systemElement.style.height = `${size}px`;
                
                // Set color based on type
                systemElement.style.backgroundColor = gameSettings.galaxy.systemColors[system.type];
                
                // Add outpost indicator if established
                if (system.outpostEstablished) {
                    systemElement.style.border = '2px solid white';
                }
                
                // Add glow based on rarity
                systemElement.style.boxShadow = `0 0 ${size/2}px ${gameSettings.galaxy.rarityColors[system.rarity]}`;
                
                // Add event listeners
                systemElement.addEventListener('mouseover', (e) => {
                    showSystemTooltip(system, e);
                });
                
                systemElement.addEventListener('mouseout', () => {
                    hideSystemTooltip();
                });
                
                systemElement.addEventListener('click', () => {
                    selectGalaxySystem(system);
                });
                
                mapContainer.appendChild(systemElement);
            }
        }
        
        // Update the exploration radius indicator
        function updateExplorationRadius() {
            const radiusIndicator = document.getElementById('exploration-radius');
            if (!radiusIndicator) return;
            
            const mapContainer = document.getElementById('galaxy-map');
            const mapWidth = mapContainer.clientWidth;
            const mapHeight = mapContainer.clientHeight;
            const centerX = mapWidth / 2;
            const centerY = mapHeight / 2;
            
            // Calculate radius based on exploration range and zoom
            const radius = gameState.galaxy.explorationRange * gameState.galaxy.zoomLevel * 50;
            
            // Position and size the indicator
            radiusIndicator.style.left = `${centerX - radius}px`;
            radiusIndicator.style.top = `${centerY - radius}px`;
            radiusIndicator.style.width = `${radius * 2}px`;
            radiusIndicator.style.height = `${radius * 2}px`;
        }
        
        // Show tooltip for a star system
        function showSystemTooltip(system, event) {
            const tooltip = document.getElementById('star-tooltip');
            if (!tooltip) return;
            
            // Set tooltip content
            tooltip.innerHTML = `
                <div class="font-bold text-sm mb-1">${system.name}</div>
                <div class="flex justify-between text-xs mb-1">
                    <span>${capitalizeFirstLetter(system.type)}</span>
                    <span>${capitalizeFirstLetter(system.rarity)}</span>
                </div>
                <div class="text-xs mb-1">Planets: ${system.planets.length}</div>
                <div class="text-xs">${system.outpostEstablished ? ' Outpost Established' : 'No Outpost'}</div>
            `;
            
            // Position tooltip near cursor
            const mapContainer = document.getElementById('galaxy-map');
            const rect = mapContainer.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            tooltip.style.left = `${x + 15}px`;
            tooltip.style.top = `${y - 15}px`;
            
            // Show tooltip
            tooltip.style.opacity = '1';
        }
        
        // Hide system tooltip
        function hideSystemTooltip() {
            const tooltip = document.getElementById('star-tooltip');
            if (tooltip) {
                tooltip.style.opacity = '0';
            }
        }
        
        // Select a galaxy system to view details
        function selectGalaxySystem(system) {
            // Show system details panel
            const detailsPanel = document.getElementById('system-details-panel');
            detailsPanel.classList.remove('hidden');
            
            // Update system details
            document.getElementById('selected-system-name').textContent = system.name;
            document.getElementById('selected-system-type').textContent = capitalizeFirstLetter(system.type);
            document.getElementById('selected-system-description').textContent = system.description;
            document.getElementById('selected-system-coordinates').textContent = `(${system.coordinates.x}, ${system.coordinates.y})`;
            document.getElementById('selected-system-planets').textContent = system.planets.length;
            document.getElementById('selected-system-rarity').textContent = capitalizeFirstLetter(system.rarity);
            
            // Update establish outpost button
            const outpostBtn = document.getElementById('establish-outpost-btn');
            if (system.outpostEstablished) {
                outpostBtn.textContent = 'Outpost Established';
                outpostBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                outpostBtn.classList.remove('bg-galaxy', 'hover:bg-indigo-700');
                outpostBtn.disabled = true;
            } else {
                const cost = calculateOutpostCost(system);
                outpostBtn.textContent = `Establish Outpost (${cost} INF)`;
                outpostBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                outpostBtn.classList.add('bg-galaxy', 'hover:bg-indigo-700');
                outpostBtn.disabled = false;
                
                // Add event listener
                outpostBtn.onclick = () => establishOutpost(system);
            }
            
            // Populate planets list
            const planetsList = document.getElementById('system-planets-list');
            planetsList.innerHTML = '';
            
            system.planets.forEach(planet => {
                const planetElement = document.createElement('div');
                planetElement.className = 'p-2 bg-white dark:bg-gray-700 rounded border border-gray-200 dark:border-gray-600';
                
                let bonusText = '';
                if (planet.bonuses && planet.bonuses.length > 0) {
                    bonusText = planet.bonuses.map(bonus => {
                        const bonusType = gameSettings.galaxy.planetBonusTypes.find(type => type.type === bonus.type);
                        if (bonusType) {
                            return bonusType.desc.replace('{value}', bonus.value);
                        }
                        return `${bonus.type}: ${bonus.value}`;
                    }).join('<br>');
                }
                
                planetElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h5 class="font-medium text-gray-900 dark:text-gray-100">${planet.name}</h5>
                        ${planet.colonized ? 
                            '<span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-0.5 rounded">Colonized</span>' : 
                            '<button class="text-xs bg-galaxy hover:bg-indigo-700 text-white px-2 py-0.5 rounded colonize-planet-btn" data-planet-id="' + planet.id + '">Colonize</button>'
                        }
                    </div>
                    <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${planet.description || 'A planet waiting to be explored and studied.'}</p>
                    <div class="text-xs text-gray-700 dark:text-gray-300 mt-1">
                        <span class="font-medium">Bonuses:</span><br>
                        ${bonusText || 'None discovered yet'}
                    </div>
                `;
                
                planetsList.appendChild(planetElement);
            });
            
            // Add event listeners to colonize buttons
            document.querySelectorAll('.colonize-planet-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const planetId = btn.dataset.planetId;
                    colonizePlanet(system, planetId);
                });
            });
        }
        
        // Establish an outpost in a star system
        function establishOutpost(system) {
            const cost = calculateOutpostCost(system);
            
            if (gameState.resources.influence < cost) {
                showNotification('Not enough Influence to establish an outpost.', 'error');
                return;
            }
            
            // Deduct influence
            gameState.resources.influence -= cost;
            
            // Update system
            system.outpostEstablished = true;
            gameState.galaxy.stats.outpostsEstablished++;
            
            // Update UI
            updateUI();
            selectGalaxySystem(system);
            renderGalaxySystems();
            
            showNotification(`Outpost established in ${system.name}!`, 'success');
        }
        
        // Colonize a planet in a system
        function colonizePlanet(system, planetId) {
            // Find the planet
            const planet = system.planets.find(p => p.id === planetId);
            if (!planet) return;
            
            // Check if outpost is established
            if (!system.outpostEstablished) {
                showNotification('You must establish an outpost before colonizing planets.', 'error');
                return;
            }
            
            // Update planet status
            planet.colonized = true;
            gameState.galaxy.stats.planetsColonized++;
            
            // Add planet to active planets list
            gameState.galaxy.activePlanets.push({
                systemId: system.id,
                planetId: planet.id,
                systemName: system.name,
                planetName: planet.name,
                bonuses: planet.bonuses || []
            });
            
            // Update UI
            updateUI();
            selectGalaxySystem(system);
            updateOutpostsList();
            
            showNotification(`Planet ${planet.name} colonized! You now receive its bonuses.`, 'success');
        }
        
        // Update outposts list
        function updateOutpostsList() {
            const outpostsList = document.getElementById('outposts-list');
            const noOutpostsMessage = document.getElementById('no-outposts-message');
            
            if (gameState.galaxy.stats.outpostsEstablished === 0) {
                noOutpostsMessage.classList.remove('hidden');
                outpostsList.classList.add('hidden');
                return;
            }
            
            noOutpostsMessage.classList.add('hidden');
            outpostsList.classList.remove('hidden');
            
            // Clear list
            outpostsList.innerHTML = '';
            
            // Get systems with outposts
            const outpostSystems = Object.values(gameState.galaxy.discoveredSystems)
                .filter(system => system.outpostEstablished);
            
            // Create outpost cards
            outpostSystems.forEach(system => {
                const outpostCard = document.createElement('div');
                outpostCard.className = 'border border-gray-200 dark:border-gray-700 rounded-lg p-4';
                
                // Get colonized planets in this system
                const colonizedPlanets = system.planets.filter(planet => planet.colonized);
                
                // Build bonuses text
                let bonusesHtml = '';
                if (colonizedPlanets.length > 0) {
                    colonizedPlanets.forEach(planet => {
                        if (planet.bonuses && planet.bonuses.length > 0) {
                            bonusesHtml += `<div class="mt-1"><span class="text-xs font-medium">${planet.name}:</span>`;
                            bonusesHtml += '<ul class="text-xs list-disc list-inside ml-2">';
                            
                            planet.bonuses.forEach(bonus => {
                                const bonusType = gameSettings.galaxy.planetBonusTypes.find(type => type.type === bonus.type);
                                if (bonusType) {
                                    bonusesHtml += `<li>${bonusType.desc.replace('{value}', bonus.value)}</li>`;
                                }
                            });
                            
                            bonusesHtml += '</ul></div>';
                        }
                    });
                }
                
                if (bonusesHtml === '') {
                    bonusesHtml = '<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">No active bonuses yet. Colonize planets to receive bonuses.</div>';
                }
                
                outpostCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-gray-900 dark:text-dark-text">${system.name}</h3>
                        <div class="text-xs px-2 py-1 rounded" style="background-color: ${gameSettings.galaxy.systemColors[system.type]}20; color: ${gameSettings.galaxy.systemColors[system.type]};">
                            ${capitalizeFirstLetter(system.type)}
                        </div>
                    </div>
                    <div class="flex space-x-4 text-xs text-gray-600 dark:text-gray-400 mb-2">
                        <div>${colonizedPlanets.length}/${system.planets.length} Planets Colonized</div>
                        <div>${capitalizeFirstLetter(system.rarity)}</div>
                    </div>
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
                        <div class="text-xs font-medium text-gray-700 dark:text-gray-300">Active Bonuses:</div>
                        ${bonusesHtml}
                    </div>
                `;
                
                outpostsList.appendChild(outpostCard);
            });
        }
        
        // Calculate the cost of establishing an outpost
        function calculateOutpostCost(system) {
            // Base cost
            let cost = gameState.galaxy.systemCosts.base;
            
            // Distance factor - further systems cost more
            const distance = Math.sqrt(
                Math.pow(system.coordinates.x, 2) + 
                Math.pow(system.coordinates.y, 2)
            );
            
            cost = Math.round(cost * Math.pow(gameState.galaxy.systemCosts.distanceMultiplier, distance));
            
            // Rarity factor - rarer systems cost more
            const rarityMultipliers = {
                'common': 1,
                'uncommon': 1.5,
                'rare': 2,
                'legendary': 3,
                'mythic': 5
            };
            
            cost = Math.round(cost * rarityMultipliers[system.rarity]);
            
            // Observatory bonus - higher levels reduce cost
            if (gameState.facilities.observatory.built) {
                const reduction = 0.1 * gameState.facilities.observatory.level;
                cost = Math.round(cost * (1 - reduction));
            }
            
            // Cartography research bonus
            if (gameState.research.stellarCartography) {
                cost = Math.round(cost * 0.8); // 20% reduction
            }
            
            return Math.max(10, cost); // Minimum cost of 10
        }
        
        // Zoom the galaxy map
        function zoomGalaxyMap(zoomChange) {
            // Update zoom level, keeping it within bounds
            gameState.galaxy.zoomLevel = Math.max(0.5, Math.min(3, gameState.galaxy.zoomLevel + zoomChange));
            
            // Re-render systems and update exploration radius
            renderGalaxySystems();
            updateExplorationRadius();
        }
        
        // Center the galaxy map on home
        function centerGalaxyMap() {
            gameState.galaxy.viewCenter = { x: 0, y: 0 };
            
            // Re-render systems
            renderGalaxySystems();
            updateExplorationRadius();
        }
        
        // Add drag functionality to the map
        function addMapDragFunctionality() {
            const mapContainer = document.getElementById('galaxy-map');
            if (!mapContainer) return;
            
            let isDragging = false;
            let startX, startY;
            let startViewX, startViewY;
            
            mapContainer.addEventListener('mousedown', (e) => {
                // Only enable dragging with left mouse button
                if (e.button !== 0) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startViewX = gameState.galaxy.viewCenter.x;
                startViewY = gameState.galaxy.viewCenter.y;
                
                // Change cursor
                mapContainer.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                // Calculate drag distance in map coordinates
                const dx = (e.clientX - startX) / (gameState.galaxy.zoomLevel * 50);
                const dy = (e.clientY - startY) / (gameState.galaxy.zoomLevel * 50);
                
                // Update view center (inverse direction of drag)
                gameState.galaxy.viewCenter = {
                    x: startViewX - dx,
                    y: startViewY - dy
                };
                
                // Re-render systems
                renderGalaxySystems();
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    mapContainer.style.cursor = 'default';
                }
            });
            
            // Prevent default behavior for right-click on the map
            mapContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });
            
            // Touch support for mobile devices
            mapContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length !== 1) return; // Only handle single touch
                
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startViewX = gameState.galaxy.viewCenter.x;
                startViewY = gameState.galaxy.viewCenter.y;
                
                e.preventDefault(); // Prevent scrolling
            });
            
            mapContainer.addEventListener('touchmove', (e) => {
                if (!isDragging || e.touches.length !== 1) return;
                
                // Calculate drag distance in map coordinates
                const dx = (e.touches[0].clientX - startX) / (gameState.galaxy.zoomLevel * 50);
                const dy = (e.touches[0].clientY - startY) / (gameState.galaxy.zoomLevel * 50);
                
                // Update view center (inverse direction of drag)
                gameState.galaxy.viewCenter = {
                    x: startViewX - dx,
                    y: startViewY - dy
                };
                
                // Re-render systems
                renderGalaxySystems();
                
                e.preventDefault(); // Prevent scrolling
            });
            
            mapContainer.addEventListener('touchend', () => {
                isDragging = false;
            });
        }
        
        // Explore a random system in the exploration range
        function exploreRandomSystem() {
            // Check if there's already an active expedition
            if (gameState.galaxy.activeExpedition) {
                showNotification('There is already an expedition in progress.', 'info');
                return;
            }
            
            // Check if player has enough influence
            if (gameState.resources.influence < gameState.galaxy.nextSystemCost) {
                showNotification('Not enough Influence to explore a new system.', 'error');
                return;
            }
            
            // Deduct influence
            gameState.resources.influence -= gameState.galaxy.nextSystemCost;
            
            // Start expedition
            gameState.galaxy.activeExpedition = {
                startTime: Date.now(),
                duration: 30000, // 30 seconds
                progress: 0
            };
            
            // Show expedition panel
            const expeditionPanel = document.getElementById('expedition-panel');
            expeditionPanel.classList.remove('hidden');
            
            // Start expedition progress
            updateExpeditionStatus();
            
            // Update UI
            updateUI();
            
            // Increase next system cost
            gameState.galaxy.nextSystemCost = Math.floor(gameState.galaxy.nextSystemCost * 1.1);
            
            showNotification('Expedition launched! Your literary explorers are venturing into the unknown...', 'info');
        }
        
        // Update expedition status
        function updateExpeditionStatus() {
            if (!gameState.galaxy.activeExpedition) return;
            
            const expeditionPanel = document.getElementById('expedition-panel');
            const expeditionProgress = document.getElementById('expedition-progress');
            const expeditionTime = document.getElementById('expedition-time');
            const expeditionMessage = document.getElementById('expedition-message');
            
            const now = Date.now();
            const elapsed = now - gameState.galaxy.activeExpedition.startTime;
            const duration = gameState.galaxy.activeExpedition.duration;
            const remaining = Math.max(0, duration - elapsed);
            
            // Calculate progress
            const progress = Math.min(100, (elapsed / duration) * 100);
            gameState.galaxy.activeExpedition.progress = progress;
            
            // Update progress bar
            expeditionProgress.style.width = `${progress}%`;
            
            // Update time remaining
            const seconds = Math.ceil(remaining / 1000);
            expeditionTime.textContent = `0:${seconds < 10 ? '0' + seconds : seconds}`;
            
            // Update message based on progress
            if (progress < 33) {
                expeditionMessage.textContent = 'Your literary expedition is exploring the cosmos...';
            } else if (progress < 66) {
                expeditionMessage.textContent = 'The expedition has detected intriguing narrative resonances...';
            } else if (progress < 100) {
                expeditionMessage.textContent = 'A new literary system is coming into focus...';
            }
            
            // Check if expedition is complete
            if (progress >= 100) {
                // Complete the expedition
                completeExpedition();
            } else {
                // Continue updating
                setTimeout(updateExpeditionStatus, 100);
            }
        }
        
        // Complete an expedition and discover a new system
        function completeExpedition() {
            // Clear active expedition
            gameState.galaxy.activeExpedition = null;
            
            // Hide expedition panel
            const expeditionPanel = document.getElementById('expedition-panel');
            expeditionPanel.classList.add('hidden');
            
            // Generate a new star system
            const newSystem = generateRandomSystem();
            
            // Add system to discovered systems
            gameState.galaxy.discoveredSystems[newSystem.id] = newSystem;
            gameState.galaxy.stats.systemsDiscovered++;
            
            // Update UI
            updateUI();
            renderGalaxySystems();
            
            // Show discovery modal
            showDiscoveryModal(newSystem);
        }
        
        // Show the discovery modal for a newly found system
        function showDiscoveryModal(system) {
            // Update modal content
            document.getElementById('discovered-system-name').textContent = system.name;
            document.getElementById('discovered-system-description').textContent = system.description;
            document.getElementById('discovered-system-type').textContent = capitalizeFirstLetter(system.type);
            document.getElementById('discovered-system-planets').textContent = system.planets.length;
            document.getElementById('discovered-system-rarity').textContent = capitalizeFirstLetter(system.rarity);
            
            // Show modal
            document.getElementById('discovery-modal').classList.remove('hidden');
            
            // Add event listener to close button
            document.getElementById('close-discovery-modal').addEventListener('click', () => {
                document.getElementById('discovery-modal').classList.add('hidden');
                
                // Select the discovered system
                selectGalaxySystem(system);
            });
        }
        
        // Generate a random star system
        function generateRandomSystem() {
            // Generate random coordinates within exploration range
            let x, y, distance;
            const maxAttempts = 20;
            let attempts = 0;
            
            // Keep trying until we find coordinates that aren't too close to existing systems
            do {
                // Random angle
                const angle = Math.random() * Math.PI * 2;
                
                // Random distance within exploration range
                const randomFactor = 0.3 + Math.random() * 0.7; // 30-100% of max range
                distance = gameState.galaxy.explorationRange * randomFactor;
                
                // Calculate coordinates
                x = Math.round(Math.cos(angle) * distance * 10) / 10;
                y = Math.round(Math.sin(angle) * distance * 10) / 10;
                
                // Check if too close to existing systems
                const tooClose = Object.values(gameState.galaxy.discoveredSystems).some(system => {
                    const dx = system.coordinates.x - x;
                    const dy = system.coordinates.y - y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    return dist < 0.5; // Minimum distance between systems
                });
                
                if (!tooClose) break;
                attempts++;
            } while (attempts < maxAttempts);
            
            // Generate system properties
            const systemId = `system-${Date.now()}`;
            const systemType = weightedRandomChoice(gameSettings.galaxy.systemTypes);
            
            // Weighted random rarity
            const rarityChoice = weightedRandomFromArray(gameSettings.galaxy.systemRarities);
            
            // Generate system name
            const name = generateSystemName();
            
            // Determine number of planets based on rarity
            const planetCounts = {
                'common': 1 + Math.floor(Math.random() * 2), // 1-2
                'uncommon': 2 + Math.floor(Math.random() * 2), // 2-3
                'rare': 3 + Math.floor(Math.random() * 2), // 3-4
                'legendary': 4 + Math.floor(Math.random() * 2), // 4-5
                'mythic': 5 // Always 5
            };
            
            const numPlanets = planetCounts[rarityChoice];
            
            // Generate planets
            const planets = [];
            for (let i = 0; i < numPlanets; i++) {
                planets.push(generatePlanet(systemId, i, rarityChoice));
            }
            
            // Create system description based on type and rarity
            const typeDesc = gameSettings.galaxy.baseTypeDescriptions[systemType];
            const rarityDesc = gameSettings.galaxy.baseRarityDescriptions[rarityChoice];
            
            let description = `${rarityDesc} ${typeDesc}`;
            
            // Add variety based on distance
            if (distance > gameState.galaxy.explorationRange * 0.8) {
                description = `Located at the edges of known space, this ${description.toLowerCase()}`;
            } else if (distance < gameState.galaxy.explorationRange * 0.3) {
                description = `Situated relatively close to home, this ${description.toLowerCase()}`;
            }
            
            // Create the system object
            return {
                id: systemId,
                name: name,
                coordinates: { x, y },
                type: systemType,
                rarity: rarityChoice,
                discovered: true,
                outpostEstablished: false,
                description: description,
                planets: planets
            };
        }
        
        // Generate a random planet
        function generatePlanet(systemId, index, systemRarity) {
            // Generate planet name
            const name = generatePlanetName();
            
            // Generate planet bonuses based on rarity
            const bonuses = [];
            
            // Determine number of bonuses based on rarity
            const bonusCounts = {
                'common': 1,
                'uncommon': 1,
                'rare': Math.random() < 0.5 ? 1 : 2, // 50% chance of 2
                'legendary': 2,
                'mythic': Math.random() < 0.5 ? 2 : 3 // 50% chance of 3
            };
            
            const numBonuses = bonusCounts[systemRarity];
            
            // Bonus values are higher for rarer systems
            const bonusMultipliers = {
                'common': 0.5,
                'uncommon': 0.7,
                'rare': 1.0,
                'legendary': 1.3,
                'mythic': 1.6
            };
            
            const multiplier = bonusMultipliers[systemRarity];
            
            // Generate the bonuses
            const possibleBonusTypes = [...gameSettings.galaxy.planetBonusTypes];
            
            for (let i = 0; i < numBonuses; i++) {
                if (possibleBonusTypes.length === 0) break;
                
                // Pick a random bonus type
                const randomIndex = Math.floor(Math.random() * possibleBonusTypes.length);
                const bonusType = possibleBonusTypes.splice(randomIndex, 1)[0];
                
                // Generate a value for the bonus
                let value;
                
                // For percentage-based bonuses
                if (bonusType.type.includes('_gain') || bonusType.type.includes('_per_') || 
                    bonusType.type === 'completion_bonus' || bonusType.type === 'discovery_chance') {
                    // Calculate a value between 50-100% of max * multiplier
                    value = Math.round((0.5 + Math.random() * 0.5) * bonusType.max * multiplier);
                    
                    // Ensure minimum value of at least 3% for percentage bonuses
                    value = Math.max(3, value);
                }
                // For passive resource generation
                else if (bonusType.type.startsWith('passive_')) {
                    // Much smaller values for passive generation
                    value = Math.round((0.2 + Math.random() * 0.8) * bonusType.max * multiplier * 10) / 10;
                    
                    // Ensure minimum value of 0.1
                    value = Math.max(0.1, value);
                }
                // For special genre bonus
                else if (bonusType.type === 'genre_bonus') {
                    value = Math.round((0.5 + Math.random() * 0.5) * bonusType.max * multiplier);
                    
                    // Ensure minimum value of at least 5% for genre bonuses
                    value = Math.max(5, value);
                }
                
                bonuses.push({
                    type: bonusType.type,
                    value: value
                });
            }
            
            // Generate a description based on bonuses
            let description = `A ${randomPlanetAdjective()} planet with `;
            
            if (bonuses.length === 0) {
                description += 'undiscovered potential.';
            } else {
                const bonusDescriptions = bonuses.map(bonus => {
                    const bonusType = gameSettings.galaxy.planetBonusTypes.find(type => type.type === bonus.type);
                    if (bonusType) {
                        return bonusType.desc.replace('{value}', bonus.value).toLowerCase();
                    }
                    return `${bonus.type}: ${bonus.value}`;
                });
                
                description += bonusDescriptions.join(' and ') + '.';
            }
            
            return {
                id: `${systemId}-planet-${index}`,
                name: name,
                colonized: false,
                bonuses: bonuses,
                description: description
            };
        }
        
        // Generate a random system name
        function generateSystemName() {
            const patterns = gameSettings.galaxy.systemNamePatterns;
            const pattern = patterns[Math.floor(Math.random() * patterns.length)];
            
            // Choose random prefix and suffix from literary themes
            const prefixOptions = [
                // Random cosmic prefixes
                "Alpha", "Beta", "Gamma", "Delta", "Epsilon", "Zeta", "Theta", "Kappa",
                "Nova", "Nebula", "Pulsar", "Orion", "Andromeda", "Lyra", "Pegasus", "Aquila",
                "Vega", "Polaris", "Sirius", "Arcturus", "Antares", "Canopus", "Rigel", "Procyon",
                "Aldebaran", "Castor", "Pollux", "Regulus", "Spica", "Altair", "Deneb", "Fomalhaut",
                // Literary-inspired prefixes
                "Quill", "Lexicon", "Codex", "Tome", "Saga", "Epic", "Fable", "Hymn",
                "Chronicle", "Verse", "Sonnet", "Stanza", "Lore", "Prose", "Rhyme", "Script",
                "Mythos", "Atlas", "Archive", "Grimoire", "Folio", "Scroll", "Libri", "Canon",
                "Opus", "Scribe", "Muse", "Poet", "Bard", "Logos", "Novella", "Compendium"
            ];
            
            const suffixOptions = [
                // Numeric and sector suffixes
                "Prime", "Major", "Minor", "Sector", "Quadrant", "Reach", "Expanse", "Void",
                "Cluster", "Nexus", "Core", "Rim", "Belt", "Cloud", "Stream", "Chain",
                // Literary-inspired suffixes
                "Archive", "Lexicon", "Library", "Repository", "Vault", "Sanctuary", "Academy", "Haven",
                "Athenaeum", "Collection", "Anthology", "Index", "Concordance", "Testament", "Compendium", "Tome"
            ];
            
            // Generate a few letters and numbers for patterns
            const letter = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // A-Z
            const number = Math.floor(Math.random() * 999) + 1;
            
            // Replace placeholders in the pattern
            return pattern
                .replace('{prefix}', prefixOptions[Math.floor(Math.random() * prefixOptions.length)])
                .replace('{suffix}', suffixOptions[Math.floor(Math.random() * suffixOptions.length)])
                .replace('{letter}', letter)
                .replace('{number}', number);
        }
        
        // Generate a random planet name
        function generatePlanetName() {
            const prefixes = gameSettings.galaxy.planetNamePrefixes;
            const suffixes = gameSettings.galaxy.planetNameSuffixes;
            
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            
            // 25% chance to just use the prefix with a number
            if (Math.random() < 0.25) {
                const number = Math.floor(Math.random() * 99) + 1;
                return `${prefix}-${number}`;
            }
            
            // Otherwise, use prefix + suffix
            return `${prefix} ${suffix}`;
        }
        
        // Generate a random adjective for planet descriptions
        function randomPlanetAdjective() {
            const adjectives = [
                "verdant", "arid", "frozen", "temperate", "humid", "barren", "lush", "volcanic",
                "crystalline", "gaseous", "oceanic", "mountainous", "desert", "jungle", "tundra", "rocky",
                "mysterious", "ancient", "radiant", "shadowy", "enigmatic", "vibrant", "tranquil", "chaotic",
                "ethereal", "literary", "scholarly", "poetic", "storied", "mythical", "legendary", "narrative"
            ];
            
            return adjectives[Math.floor(Math.random() * adjectives.length)];
        }
        
        // Helper function: Choose random item from array
        function weightedRandomChoice(array) {
            return array[Math.floor(Math.random() * array.length)];
        }
        
        // Helper function: Get weighted random item from array of {item, weight} objects
        function weightedRandomFromArray(weightedArray) {
            // Calculate total weight
            const totalWeight = weightedArray.reduce((sum, item) => sum + item.weight, 0);
            
            // Get a random weight value
            let randomWeight = Math.random() * totalWeight;
            
            // Find the item that corresponds to the random weight
            for (const item of weightedArray) {
                randomWeight -= item.weight;
                if (randomWeight <= 0) {
                    return item.rarity;
                }
            }
            
            // Fallback
            return weightedArray[0].rarity;
        }
        
        // Update genre distribution in stats tab
        function updateGenreDistribution() {
            const genreDistributionContainer = document.getElementById('genre-distribution');
            if (!genreDistributionContainer) return;
            
            // Clear the container
            genreDistributionContainer.innerHTML = '';
            
            // Get total books
            const totalBooks = gameState.stats.booksCompleted;
            if (totalBooks === 0) {
                genreDistributionContainer.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center py-3">No books completed yet.</div>';
                return;
            }
            
            // Add standard genres
            const standardGenres = [
                { key: 'sci-fi', name: 'Science Fiction' },
                { key: 'fantasy', name: 'Fantasy' },
                { key: 'non-fiction', name: 'Non-Fiction' },
                { key: 'mystery', name: 'Mystery/Thriller' },
                { key: 'history', name: 'History' },
                { key: 'science', name: 'Science' },
                { key: 'biography', name: 'Biography' }
            ];
            
            standardGenres.forEach(genre => {
                const count = gameState.stats.genreDistribution[genre.key] || 0;
                if (count > 0) {
                    addGenreBar(genre.name, count, totalBooks, genreDistributionContainer, 'blue-600');
                }
            });
            
            // Add custom genres
            const customGenres = gameState.stats.genreDistribution.custom;
            let colorIndex = 0;
            
            for (const [genreName, count] of Object.entries(customGenres)) {
                if (count > 0) {
                    const colorClass = gameSettings.genreColors[colorIndex % gameSettings.genreColors.length];
                    addGenreBar(genreName, count, totalBooks, genreDistributionContainer, colorClass);
                    colorIndex++;
                }
            }
        }
        
        // Helper function to add a genre bar to the distribution
        function addGenreBar(genreName, count, totalBooks, container, colorClass) {
            const genreDiv = document.createElement('div');
            genreDiv.innerHTML = `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-700 dark:text-gray-300">${genreName}</span>
                    <span class="text-gray-700 dark:text-gray-300">${count} book${count !== 1 ? 's' : ''}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mt-1">
                    <div class="bg-${colorClass} h-2.5 rounded-full" style="width: ${(count / totalBooks) * 100}%"></div>
                </div>
            `;
            container.appendChild(genreDiv);
        }
        
        // Update Enlightenment UI
        function updateEnlightenmentUI() {
            // Update available EP
            document.getElementById('available-ep').textContent = gameState.prestige.enlightenmentPoints;
            
            // Update resource production upgrade
            const resourceProd = gameState.prestige.permanentUpgrades.resourceProduction;
            document.getElementById('resource-production-bonus').textContent = resourceProd.bonus;
            document.getElementById('resource-production-cost').textContent = resourceProd.cost;
            
            // Update starting resources upgrade
            const startingResources = gameState.prestige.permanentUpgrades.startingResources;
            document.getElementById('starting-resources-bonus').textContent = startingResources.kpBonus;
            document.getElementById('starting-rp-bonus').textContent = startingResources.rpBonus;
            document.getElementById('starting-resources-cost').textContent = startingResources.cost;
            
            // Update reading efficiency upgrade
            const readingEfficiency = gameState.prestige.permanentUpgrades.readingEfficiency;
            document.getElementById('reading-efficiency-bonus').textContent = readingEfficiency.bonus;
            document.getElementById('reading-efficiency-cost').textContent = readingEfficiency.cost;
            
            // Update experience boost upgrade
            const experienceBoost = gameState.prestige.permanentUpgrades.experienceBoost;
            document.getElementById('experience-boost-bonus').textContent = experienceBoost.bonus;
            document.getElementById('experience-boost-cost').textContent = experienceBoost.cost;
            
            // Update auto research upgrade
            const autoResearch = gameState.prestige.permanentUpgrades.autoResearch;
            document.getElementById('auto-research-level').textContent = autoResearch.level;
            document.getElementById('auto-research-cost').textContent = autoResearch.cost;
            
            // Update auto research button text based on level
            const autoResearchBtn = document.getElementById('upgrade-auto-research');
            if (autoResearch.level === 0) {
                autoResearchBtn.textContent = "Upgrade (Unlock Auto Research)";
            } else if (autoResearch.level < autoResearch.maxLevel) {
                const nextResearch = getNextAutoResearch(autoResearch.level);
                autoResearchBtn.textContent = `Upgrade (Auto ${nextResearch})`;
            } else {
                autoResearchBtn.textContent = "Maximum Level";
                autoResearchBtn.classList.add('bg-gray-200', 'text-gray-500');
                autoResearchBtn.classList.remove('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            }
            
            // Update facility retention upgrade
            const facilityRetention = gameState.prestige.permanentUpgrades.facilityRetention;
            document.getElementById('facility-retention-level').textContent = facilityRetention.level;
            document.getElementById('facility-retention-cost').textContent = facilityRetention.cost;
            
            // Update facility retention button text based on level
            const facilityRetentionBtn = document.getElementById('upgrade-facility-retention');
            if (facilityRetention.level === 0) {
                facilityRetentionBtn.textContent = "Upgrade (Retain Research Center)";
            } else if (facilityRetention.level === 1) {
                facilityRetentionBtn.textContent = "Upgrade (Retain Knowledge Repository)";
            } else if (facilityRetention.level === 2) {
                facilityRetentionBtn.textContent = "Upgrade (Retain Observatory)";
            } else {
                facilityRetentionBtn.textContent = "Maximum Level";
                facilityRetentionBtn.classList.add('bg-gray-200', 'text-gray-500');
                facilityRetentionBtn.classList.remove('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            }
            
            // Update button states based on available EP
            updateEnlightenmentButtonStates();
            
            // Update EP preview calculations
            updateEpPreview();
        }
        
        // Update Enlightenment Button States
        function updateEnlightenmentButtonStates() {
            const ep = gameState.prestige.enlightenmentPoints;
            
            // Resource Production
            const resourceProdBtn = document.getElementById('upgrade-resource-production');
            const resourceProdCost = gameState.prestige.permanentUpgrades.resourceProduction.cost;
            if (ep < resourceProdCost) {
                resourceProdBtn.classList.add('bg-gray-200', 'text-gray-500');
                resourceProdBtn.classList.remove('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            } else {
                resourceProdBtn.classList.remove('bg-gray-200', 'text-gray-500');
                resourceProdBtn.classList.add('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            }
            
            // Starting Resources
            const startingResourcesBtn = document.getElementById('upgrade-starting-resources');
            const startingResourcesCost = gameState.prestige.permanentUpgrades.startingResources.cost;
            if (ep < startingResourcesCost) {
                startingResourcesBtn.classList.add('bg-gray-200', 'text-gray-500');
                startingResourcesBtn.classList.remove('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            } else {
                startingResourcesBtn.classList.remove('bg-gray-200', 'text-gray-500');
                startingResourcesBtn.classList.add('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            }
            
            // Reading Efficiency
            const readingEfficiencyBtn = document.getElementById('upgrade-reading-efficiency');
            const readingEfficiencyCost = gameState.prestige.permanentUpgrades.readingEfficiency.cost;
            if (ep < readingEfficiencyCost) {
                readingEfficiencyBtn.classList.add('bg-gray-200', 'text-gray-500');
                readingEfficiencyBtn.classList.remove('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            } else {
                readingEfficiencyBtn.classList.remove('bg-gray-200', 'text-gray-500');
                readingEfficiencyBtn.classList.add('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            }
            
            // Experience Boost
            const experienceBoostBtn = document.getElementById('upgrade-experience-boost');
            const experienceBoostCost = gameState.prestige.permanentUpgrades.experienceBoost.cost;
            if (ep < experienceBoostCost) {
                experienceBoostBtn.classList.add('bg-gray-200', 'text-gray-500');
                experienceBoostBtn.classList.remove('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            } else {
                experienceBoostBtn.classList.remove('bg-gray-200', 'text-gray-500');
                experienceBoostBtn.classList.add('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            }
            
            // Auto Research
            const autoResearchBtn = document.getElementById('upgrade-auto-research');
            const autoResearch = gameState.prestige.permanentUpgrades.autoResearch;
            if (autoResearch.level >= autoResearch.maxLevel) {
                autoResearchBtn.classList.add('bg-gray-200', 'text-gray-500');
                autoResearchBtn.classList.remove('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            } else if (ep < autoResearch.cost) {
                autoResearchBtn.classList.add('bg-gray-200', 'text-gray-500');
                autoResearchBtn.classList.remove('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            } else {
                autoResearchBtn.classList.remove('bg-gray-200', 'text-gray-500');
                autoResearchBtn.classList.add('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            }
            
            // Facility Retention
            const facilityRetentionBtn = document.getElementById('upgrade-facility-retention');
            const facilityRetention = gameState.prestige.permanentUpgrades.facilityRetention;
            if (facilityRetention.level >= facilityRetention.maxLevel) {
                facilityRetentionBtn.classList.add('bg-gray-200', 'text-gray-500');
                facilityRetentionBtn.classList.remove('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            } else if (ep < facilityRetention.cost) {
                facilityRetentionBtn.classList.add('bg-gray-200', 'text-gray-500');
                facilityRetentionBtn.classList.remove('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            } else {
                facilityRetentionBtn.classList.remove('bg-gray-200', 'text-gray-500');
                facilityRetentionBtn.classList.add('bg-enlightenment', 'hover:bg-red-600', 'text-white');
            }
        }
        
        // Get next auto research name based on level
        function getNextAutoResearch(level) {
            switch (level) {
                case 0: return "Speed Reading";
                case 1: return "Comprehension Algorithms";
                case 2: return "Advanced Construction";
                case 3: return "Automated Collection";
                case 4: return "Facility Optimization";
                default: return "Maximum Level";
            }
        }
        
        // Update EP Preview Calculations
        function updateEpPreview() {
            // Calculate EP from player level
            const epFromLevel = Math.floor(gameState.player.level * gameSettings.epCalculation.levelFactor);
            document.getElementById('ep-from-level').textContent = epFromLevel;
            
            // Calculate EP from books completed
            const epFromBooks = Math.floor(gameState.stats.booksCompleted * gameSettings.epCalculation.bookFactor);
            document.getElementById('ep-from-books').textContent = epFromBooks;
            
            // Calculate EP from research
            let researchCount = 0;
            if (gameState.research.speedReading) researchCount++;
            if (gameState.research.comprehensionAlgorithms) researchCount++;
            if (gameState.research.advancedConstruction) researchCount++;
            if (gameState.research.automatedCollection) researchCount++;
            if (gameState.research.facilityOptimization) researchCount++;
            if (gameState.research.stellarCartography) researchCount++;
            
            const epFromResearch = Math.floor(researchCount * gameSettings.epCalculation.researchFactor);
            document.getElementById('ep-from-research').textContent = epFromResearch;
            
            // Calculate total EP gain
            const totalEpGain = epFromLevel + epFromBooks + epFromResearch;
            document.getElementById('total-ep-gain').textContent = totalEpGain;
            document.getElementById('confirm-ep-gain').textContent = totalEpGain;
        }
        
        // Perform Ascension/Prestige
        function performAscension() {
            // Calculate EP to be earned
            const epFromLevel = Math.floor(gameState.player.level * gameSettings.epCalculation.levelFactor);
            const epFromBooks = Math.floor(gameState.stats.booksCompleted * gameSettings.epCalculation.bookFactor);
            
            let researchCount = 0;
            if (gameState.research.speedReading) researchCount++;
            if (gameState.research.comprehensionAlgorithms) researchCount++;
            if (gameState.research.advancedConstruction) researchCount++;
            if (gameState.research.automatedCollection) researchCount++;
            if (gameState.research.facilityOptimization) researchCount++;
            if (gameState.research.stellarCartography) researchCount++;
            
            const epFromResearch = Math.floor(researchCount * gameSettings.epCalculation.researchFactor);
            
            const totalEpGain = epFromLevel + epFromBooks + epFromResearch;
            
            // Update lifetime stats
            gameState.lifetimeStats.totalPrestiges++;
            gameState.lifetimeStats.maxLevel = Math.max(gameState.lifetimeStats.maxLevel, gameState.player.level);
            gameState.lifetimeStats.maxBooks = Math.max(gameState.lifetimeStats.maxBooks, gameState.stats.booksCompleted);
            gameState.lifetimeStats.totalEnlightenmentPoints += totalEpGain;
            
            // Add EP to player
            gameState.prestige.enlightenmentPoints += totalEpGain;
            gameState.prestige.totalEnlightenmentEarned += totalEpGain;
            gameState.prestige.level++;
            
            // Backup permanent upgrades and other persistent data
            const permanentUpgrades = JSON.parse(JSON.stringify(gameState.prestige.permanentUpgrades));
            const lifetimeStats = JSON.parse(JSON.stringify(gameState.lifetimeStats));
            const prestige = {
                unlocked: true,
                level: gameState.prestige.level,
                enlightenmentPoints: gameState.prestige.enlightenmentPoints,
                totalEnlightenmentEarned: gameState.prestige.totalEnlightenmentEarned,
                permanentUpgrades: permanentUpgrades
            };
            
            // Backup custom genres stats
            const customGenres = JSON.parse(JSON.stringify(gameState.stats.genreDistribution.custom));
            
            // Backup galaxy data that should persist
            const galaxyBackup = {
                // Only keep discovered systems data
                discoveredSystems: JSON.parse(JSON.stringify(gameState.galaxy.discoveredSystems)),
                // Keep statistics
                stats: JSON.parse(JSON.stringify(gameState.galaxy.stats))
            };
            
            // Reset game state
            resetGameForPrestige();
            
            // Restore permanent upgrades and other persistent data
            gameState.prestige = prestige;
            gameState.lifetimeStats = lifetimeStats;
            gameState.research.enlightenmentStudies = true;
            gameState.stats.genreDistribution.custom = customGenres;
            
            // Restore galaxy data
            gameState.galaxy.discoveredSystems = galaxyBackup.discoveredSystems;
            gameState.galaxy.stats = galaxyBackup.stats;
            
            // Apply starting bonuses from permanent upgrades
            applyStartingBonuses();
            
            // Update UI
            updateUI();
            
            // Show notification
            showNotification(`Ascension complete! You gained ${totalEpGain} Enlightenment Points.`, 'success');
        }
        
        // Reset game state for prestige (keeps permanent upgrades)
        function resetGameForPrestige() {
            gameState.player = {
                level: 1,
                experiencePoints: 0,
                experienceToNextLevel: 100
            };
            
            gameState.resources = {
                knowledgePoints: 50,
                researchPoints: 0,
                influence: 0
            };
            
            gameState.facilities = {
                researchCenter: {
                    level: 0,
                    built: false,
                    output: 0,
                    cost: 50,
                    upgradeCost: 100
                },
                knowledgeRepository: {
                    level: 0,
                    built: false,
                    bonus: 0,
                    cost: 100,
                    rpCost: 20,
                    upgradeCost: 200,
                    upgradeRpCost: 40
                },
                academyComplex: {
                    level: 0,
                    built: false,
                    bonus: 0,
                    cost: 300,
                    rpCost: 100,
                    upgradeCost: 500,
                    upgradeRpCost: 150,
                    prerequisites: {
                        playerLevel: 3,
                        researchCenterLevel: 2
                    }
                },
                observatory: {
                    level: 0,
                    built: false,
                    bonus: 0,
                    cost: 200,
                    rpCost: 50,
                    upgradeCost: 350,
                    upgradeRpCost: 100,
                    prerequisites: {
                        playerLevel: 2,
                        booksCompleted: 5
                    }
                },
                virtualLibrary: {
                    level: 0,
                    built: false,
                    bonus: 0,
                    cost: 500,
                    rpCost: 200,
                    upgradeCost: 800,
                    upgradeRpCost: 300,
                    prerequisites: {
                        playerLevel: 4,
                        knowledgeRepositoryLevel: 3,
                        booksCompleted: 15
                    }
                }
            };
            
            gameState.research = {
                speedReading: false,
                comprehensionAlgorithms: false,
                advancedConstruction: false,
                automatedCollection: false,
                facilityOptimization: false,
                enlightenmentStudies: false,
                stellarCartography: false
            };
            
            gameState.stats = {
                booksCompleted: 0,
                pagesRead: 0,
                minutesRead: 0,
                totalKpGenerated: 0,
                genreDistribution: {
                    'sci-fi': 0,
                    'fantasy': 0,
                    'non-fiction': 0,
                    'mystery': 0,
                    'history': 0,
                    'science': 0,
                    'biography': 0,
                    'custom': {}
                }
            };
            
            gameState.currentBooks = [];
            
            // Reset galaxy exploration system but keep discovery data
            gameState.galaxy.unlocked = false;
            gameState.galaxy.viewCenter = { x: 0, y: 0 };
            gameState.galaxy.currentCoordinates = { x: 0, y: 0 };
            gameState.galaxy.explorationRange = 3;
            gameState.galaxy.zoomLevel = 1;
            gameState.galaxy.nextSystemCost = 25;
            gameState.galaxy.activePlanets = [];
            gameState.galaxy.activeExpedition = null;
        }
        
        // Apply starting bonuses from permanent upgrades
        function applyStartingBonuses() {
            // Apply starting resources bonus
            const startingResources = gameState.prestige.permanentUpgrades.startingResources;
            gameState.resources.knowledgePoints += startingResources.kpBonus;
            gameState.resources.researchPoints += startingResources.rpBonus;
            
            // Apply auto research if purchased
            const autoResearch = gameState.prestige.permanentUpgrades.autoResearch;
            if (autoResearch.level >= 1) {
                gameState.research.speedReading = true;
            }
            if (autoResearch.level >= 2) {
                gameState.research.comprehensionAlgorithms = true;
            }
            if (autoResearch.level >= 3) {
                gameState.research.advancedConstruction = true;
            }
            if (autoResearch.level >= 4) {
                gameState.research.automatedCollection = true;
            }
            if (autoResearch.level >= 5) {
                gameState.research.facilityOptimization = true;
            }
            
            // Apply facility retention if purchased
            const facilityRetention = gameState.prestige.permanentUpgrades.facilityRetention;
            if (facilityRetention.level >= 1) {
                // Unlock Research Center
                gameState.facilities.researchCenter.built = true;
                gameState.facilities.researchCenter.level = 1;
                gameState.facilities.researchCenter.output = 3; // Increased from 2 to compensate for adjacency removal
            }
            if (facilityRetention.level >= 2) {
                // Unlock Knowledge Repository
                gameState.facilities.knowledgeRepository.built = true;
                gameState.facilities.knowledgeRepository.level = 1;
                gameState.facilities.knowledgeRepository.bonus = 15; // Increased from 10 to compensate for adjacency removal
            }
            if (facilityRetention.level >= 3) {
                // Unlock Observatory
                gameState.facilities.observatory.built = true;
                gameState.facilities.observatory.level = 1;
            }
        }
        
        // Update facility buttons (build vs upgrade)
        function updateFacilityButtons() {
            // Research Center
            if (gameState.facilities.researchCenter.built) {
                document.getElementById('build-research-center').classList.add('hidden');
                document.getElementById('upgrade-research-center').classList.remove('hidden');
                document.getElementById('upgrade-research-center').textContent = `Upgrade to Level ${gameState.facilities.researchCenter.level + 1} (${gameState.facilities.researchCenter.upgradeCost} KP)`;
                
                if (gameState.resources.knowledgePoints < gameState.facilities.researchCenter.upgradeCost) {
                    document.getElementById('upgrade-research-center').classList.add('bg-gray-200', 'text-gray-500');
                    document.getElementById('upgrade-research-center').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                } else {
                    document.getElementById('upgrade-research-center').classList.remove('bg-gray-200', 'text-gray-500');
                    document.getElementById('upgrade-research-center').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                }
            } else {
                if (gameState.resources.knowledgePoints < gameState.facilities.researchCenter.cost) {
                    document.getElementById('build-research-center').classList.add('bg-gray-200', 'text-gray-500');
                    document.getElementById('build-research-center').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                } else {
                    document.getElementById('build-research-center').classList.remove('bg-gray-200', 'text-gray-500');
                    document.getElementById('build-research-center').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                }
            }
            
            // Knowledge Repository
            if (gameState.facilities.knowledgeRepository.built) {
                document.getElementById('build-repository').classList.add('hidden');
                document.getElementById('upgrade-repository').classList.remove('hidden');
                document.getElementById('upgrade-repository').textContent = `Upgrade to Level ${gameState.facilities.knowledgeRepository.level + 1} (${gameState.facilities.knowledgeRepository.upgradeCost} KP, ${gameState.facilities.knowledgeRepository.upgradeRpCost} RP)`;
                
                if (gameState.resources.knowledgePoints < gameState.facilities.knowledgeRepository.upgradeCost || 
                    gameState.resources.researchPoints < gameState.facilities.knowledgeRepository.upgradeRpCost) {
                    document.getElementById('upgrade-repository').classList.add('bg-gray-200', 'text-gray-500');
                    document.getElementById('upgrade-repository').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                } else {
                    document.getElementById('upgrade-repository').classList.remove('bg-gray-200', 'text-gray-500');
                    document.getElementById('upgrade-repository').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                }
            } else {
                if (gameState.resources.knowledgePoints < gameState.facilities.knowledgeRepository.cost || 
                    gameState.resources.researchPoints < gameState.facilities.knowledgeRepository.rpCost) {
                    document.getElementById('build-repository').classList.add('bg-gray-200', 'text-gray-500');
                    document.getElementById('build-repository').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                } else {
                    document.getElementById('build-repository').classList.remove('bg-gray-200', 'text-gray-500');
                    document.getElementById('build-repository').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                }
            }
            
            // Academy Complex
            const academyUnlocked = gameState.player.level >= gameState.facilities.academyComplex.prerequisites.playerLevel && 
                                      gameState.facilities.researchCenter.level >= gameState.facilities.academyComplex.prerequisites.researchCenterLevel;
            
            if (academyUnlocked) {
                document.querySelector('#facility-academy-complex .absolute').classList.add('hidden');
                
                if (gameState.facilities.academyComplex.built) {
                    document.getElementById('build-academy').classList.add('hidden');
                    // Add upgrade button if not exists
                    let upgradeBtn = document.getElementById('upgrade-academy');
                    if (!upgradeBtn) {
                        upgradeBtn = document.createElement('button');
                        upgradeBtn.id = 'upgrade-academy';
                        upgradeBtn.className = 'w-full bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200';
                        upgradeBtn.textContent = `Upgrade to Level ${gameState.facilities.academyComplex.level + 1} (${gameState.facilities.academyComplex.upgradeCost} KP, ${gameState.facilities.academyComplex.upgradeRpCost} RP)`;
                        document.getElementById('build-academy').after(upgradeBtn);
                        
                        // Add event listener
                        upgradeBtn.addEventListener('click', upgradeAcademy);
                    } else {
                        upgradeBtn.classList.remove('hidden');
                        upgradeBtn.textContent = `Upgrade to Level ${gameState.facilities.academyComplex.level + 1} (${gameState.facilities.academyComplex.upgradeCost} KP, ${gameState.facilities.academyComplex.upgradeRpCost} RP)`;
                    }
                    
                    if (gameState.resources.knowledgePoints < gameState.facilities.academyComplex.upgradeCost || 
                        gameState.resources.researchPoints < gameState.facilities.academyComplex.upgradeRpCost) {
                        upgradeBtn.classList.add('bg-gray-200', 'text-gray-500');
                        upgradeBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    } else {
                        upgradeBtn.classList.remove('bg-gray-200', 'text-gray-500');
                        upgradeBtn.classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    }
                } else {
                    document.getElementById('build-academy').textContent = `Build (${gameState.facilities.academyComplex.cost} KP, ${gameState.facilities.academyComplex.rpCost} RP)`;
                    
                    if (gameState.resources.knowledgePoints < gameState.facilities.academyComplex.cost || 
                        gameState.resources.researchPoints < gameState.facilities.academyComplex.rpCost) {
                        document.getElementById('build-academy').classList.add('bg-gray-200', 'text-gray-500');
                        document.getElementById('build-academy').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    } else {
                        document.getElementById('build-academy').classList.remove('bg-gray-200', 'text-gray-500');
                        document.getElementById('build-academy').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    }
                }
            }
            
            // Observatory
            const observatoryUnlocked = gameState.player.level >= gameState.facilities.observatory.prerequisites.playerLevel && 
                                          gameState.stats.booksCompleted >= gameState.facilities.observatory.prerequisites.booksCompleted;
            
            if (observatoryUnlocked) {
                document.querySelector('#facility-observatory .absolute').classList.add('hidden');
                
                if (gameState.facilities.observatory.built) {
                    document.getElementById('build-observatory').classList.add('hidden');
                    // Add upgrade button if not exists
                    let upgradeBtn = document.getElementById('upgrade-observatory');
                    if (!upgradeBtn) {
                        upgradeBtn = document.createElement('button');
                        upgradeBtn.id = 'upgrade-observatory';
                        upgradeBtn.className = 'w-full bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200';
                        upgradeBtn.textContent = `Upgrade to Level ${gameState.facilities.observatory.level + 1} (${gameState.facilities.observatory.upgradeCost} KP, ${gameState.facilities.observatory.upgradeRpCost} RP)`;
                        document.getElementById('build-observatory').after(upgradeBtn);
                        
                        // Add event listener
                        upgradeBtn.addEventListener('click', upgradeObservatory);
                    } else {
                        upgradeBtn.classList.remove('hidden');
                        upgradeBtn.textContent = `Upgrade to Level ${gameState.facilities.observatory.level + 1} (${gameState.facilities.observatory.upgradeCost} KP, ${gameState.facilities.observatory.upgradeRpCost} RP)`;
                    }
                    
                    if (gameState.resources.knowledgePoints < gameState.facilities.observatory.upgradeCost || 
                        gameState.resources.researchPoints < gameState.facilities.observatory.upgradeRpCost) {
                        upgradeBtn.classList.add('bg-gray-200', 'text-gray-500');
                        upgradeBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    } else {
                        upgradeBtn.classList.remove('bg-gray-200', 'text-gray-500');
                        upgradeBtn.classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    }
                } else {
                    document.getElementById('build-observatory').textContent = `Build (${gameState.facilities.observatory.cost} KP, ${gameState.facilities.observatory.rpCost} RP)`;
                    
                    if (gameState.resources.knowledgePoints < gameState.facilities.observatory.cost || 
                        gameState.resources.researchPoints < gameState.facilities.observatory.rpCost) {
                        document.getElementById('build-observatory').classList.add('bg-gray-200', 'text-gray-500');
                        document.getElementById('build-observatory').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    } else {
                        document.getElementById('build-observatory').classList.remove('bg-gray-200', 'text-gray-500');
                        document.getElementById('build-observatory').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    }
                }
            }
            
            // Virtual Library
            const libraryUnlocked = gameState.player.level >= gameState.facilities.virtualLibrary.prerequisites.playerLevel && 
                                     gameState.facilities.knowledgeRepository.level >= gameState.facilities.virtualLibrary.prerequisites.knowledgeRepositoryLevel &&
                                     gameState.stats.booksCompleted >= gameState.facilities.virtualLibrary.prerequisites.booksCompleted;
            
            if (libraryUnlocked) {
                document.querySelector('#facility-virtual-library .absolute').classList.add('hidden');
                
                if (gameState.facilities.virtualLibrary.built) {
                    document.getElementById('build-virtual-library').classList.add('hidden');
                    // Add upgrade button if not exists
                    let upgradeBtn = document.getElementById('upgrade-virtual-library');
                    if (!upgradeBtn) {
                        upgradeBtn = document.createElement('button');
                        upgradeBtn.id = 'upgrade-virtual-library';
                        upgradeBtn.className = 'w-full bg-primary hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded focus:outline-none focus:shadow-outline transition-colors duration-200';
                        upgradeBtn.textContent = `Upgrade to Level ${gameState.facilities.virtualLibrary.level + 1} (${gameState.facilities.virtualLibrary.upgradeCost} KP, ${gameState.facilities.virtualLibrary.upgradeRpCost} RP)`;
                        document.getElementById('build-virtual-library').after(upgradeBtn);
                        
                        // Add event listener
                        upgradeBtn.addEventListener('click', upgradeVirtualLibrary);
                    } else {
                        upgradeBtn.classList.remove('hidden');
                        upgradeBtn.textContent = `Upgrade to Level ${gameState.facilities.virtualLibrary.level + 1} (${gameState.facilities.virtualLibrary.upgradeCost} KP, ${gameState.facilities.virtualLibrary.upgradeRpCost} RP)`;
                    }
                    
                    if (gameState.resources.knowledgePoints < gameState.facilities.virtualLibrary.upgradeCost || 
                        gameState.resources.researchPoints < gameState.facilities.virtualLibrary.upgradeRpCost) {
                        upgradeBtn.classList.add('bg-gray-200', 'text-gray-500');
                        upgradeBtn.classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    } else {
                        upgradeBtn.classList.remove('bg-gray-200', 'text-gray-500');
                        upgradeBtn.classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    }
                } else {
                    document.getElementById('build-virtual-library').textContent = `Build (${gameState.facilities.virtualLibrary.cost} KP, ${gameState.facilities.virtualLibrary.rpCost} RP)`;
                    
                    if (gameState.resources.knowledgePoints < gameState.facilities.virtualLibrary.cost || 
                        gameState.resources.researchPoints < gameState.facilities.virtualLibrary.rpCost) {
                        document.getElementById('build-virtual-library').classList.add('bg-gray-200', 'text-gray-500');
                        document.getElementById('build-virtual-library').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    } else {
                        document.getElementById('build-virtual-library').classList.remove('bg-gray-200', 'text-gray-500');
                        document.getElementById('build-virtual-library').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    }
                }
            }
        }
        
        // Update research buttons
        function updateResearchButtons() {
            // Speed Reading
            if (gameState.research.speedReading) {
                document.getElementById('research-speed-reading').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('research-speed-reading').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                document.getElementById('research-speed-reading').textContent = 'Researched';
            } else if (gameState.resources.researchPoints < 50) {
                document.getElementById('research-speed-reading').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('research-speed-reading').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
            } else {
                document.getElementById('research-speed-reading').classList.remove('bg-gray-200', 'text-gray-500');
                document.getElementById('research-speed-reading').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
            }
            
            // Comprehension Algorithms
            if (gameState.research.comprehensionAlgorithms) {
                document.getElementById('research-comprehension').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('research-comprehension').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                document.getElementById('research-comprehension').textContent = 'Researched';
            } else if (gameState.resources.researchPoints < 75) {
                document.getElementById('research-comprehension').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('research-comprehension').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
            } else {
                document.getElementById('research-comprehension').classList.remove('bg-gray-200', 'text-gray-500');
                document.getElementById('research-comprehension').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
            }
            
            // Advanced Construction
            if (gameState.research.advancedConstruction) {
                document.getElementById('research-construction').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('research-construction').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                document.getElementById('research-construction').textContent = 'Researched';
            } else if (gameState.resources.researchPoints < 100) {
                document.getElementById('research-construction').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('research-construction').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
            } else {
                document.getElementById('research-construction').classList.remove('bg-gray-200', 'text-gray-500');
                document.getElementById('research-construction').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
            }
            
            // Automated Collection
            if (gameState.research.automatedCollection) {
                document.getElementById('research-automation').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('research-automation').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                document.getElementById('research-automation').textContent = 'Researched';
            } else if (gameState.resources.researchPoints < 150) {
                document.getElementById('research-automation').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('research-automation').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
            } else {
                document.getElementById('research-automation').classList.remove('bg-gray-200', 'text-gray-500');
                document.getElementById('research-automation').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
            }
            
            // Facility Optimization
            if (gameState.research.facilityOptimization) {
                document.getElementById('research-optimization').classList.add('bg-gray-200', 'text-gray-500');
                document.getElementById('research-optimization').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                document.getElementById('research-optimization').textContent = 'Researched';
            } else {
                // Check if requirements are met
                const optimizationUnlocked = gameState.facilities.researchCenter.level >= 2;
                
                if (!optimizationUnlocked || gameState.resources.researchPoints < 200) {
                    document.getElementById('research-optimization').classList.add('bg-gray-200', 'text-gray-500');
                    document.getElementById('research-optimization').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                } else {
                    document.getElementById('research-optimization').classList.remove('bg-gray-200', 'text-gray-500');
                    document.getElementById('research-optimization').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                }
            }
            
            // Stellar Cartography (if available in the UI)
            if (document.getElementById('research-cartography')) {
                if (gameState.research.stellarCartography) {
                    document.getElementById('research-cartography').classList.add('bg-gray-200', 'text-gray-500');
                    document.getElementById('research-cartography').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    document.getElementById('research-cartography').textContent = 'Researched';
                } else {
                    // Check if requirements are met
                    const cartographyUnlocked = gameState.facilities.observatory.built;
                    
                    if (!cartographyUnlocked || gameState.resources.researchPoints < 150) {
                        document.getElementById('research-cartography').classList.add('bg-gray-200', 'text-gray-500');
                        document.getElementById('research-cartography').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    } else {
                        document.getElementById('research-cartography').classList.remove('bg-gray-200', 'text-gray-500');
                        document.getElementById('research-cartography').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    }
                }
            }
            
            // Enlightenment Studies (if available in the UI)
            if (document.getElementById('research-enlightenment')) {
                if (gameState.research.enlightenmentStudies) {
                    document.getElementById('research-enlightenment').classList.add('bg-gray-200', 'text-gray-500');
                    document.getElementById('research-enlightenment').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    document.getElementById('research-enlightenment').textContent = 'Researched';
                } else {
                    // Check if requirements are met
                    const enlightenmentUnlocked = 
                        gameState.player.level >= gameSettings.prestigeRequirements.playerLevel &&
                        gameState.stats.booksCompleted >= gameSettings.prestigeRequirements.booksCompleted;
                    
                    if (!enlightenmentUnlocked || gameState.resources.researchPoints < 500) {
                        document.getElementById('research-enlightenment').classList.add('bg-gray-200', 'text-gray-500');
                        document.getElementById('research-enlightenment').classList.remove('bg-primary', 'hover:bg-blue-700', 'text-white');
                    } else {
                        document.getElementById('research-enlightenment').classList.remove('bg-gray-200', 'text-gray-500');
                        document.getElementById('research-enlightenment').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    }
                }
            }
        }
        
        // Update current reading list
        function updateCurrentReadingList() {
            const listElement = document.getElementById('current-reading-list');
            
            // Clear the list
            listElement.innerHTML = '';
            
            if (gameState.currentBooks.length === 0) {
                listElement.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center py-3">No current books. Start reading!</div>';
                return;
            }
            
            // Add each book to the list
            gameState.currentBooks.forEach((book, index) => {
                const bookElement = document.createElement('div');
                bookElement.className = 'p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
                
                // Handle display of custom genre
                let displayGenre = book.genre;
                if (book.genre === 'custom' && book.customGenre) {
                    displayGenre = book.customGenre;
                } else {
                    // Convert genre key to display name
                    const genreMap = {
                        'sci-fi': 'Science Fiction',
                        'fantasy': 'Fantasy',
                        'non-fiction': 'Non-Fiction',
                        'mystery': 'Mystery/Thriller',
                        'history': 'History',
                        'science': 'Science',
                        'biography': 'Biography',
                        'other': 'Other'
                    };
                    displayGenre = genreMap[book.genre] || capitalizeFirstLetter(book.genre);
                }
                
                bookElement.innerHTML = `
                    <div class="flex justify-between">
                        <h4 class="font-medium text-gray-900 dark:text-dark-text">${book.title}</h4>
                        <span class="text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 px-2 py-1 rounded-full">${displayGenre}</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-2">
                        <span>Pages: ${book.pagesRead}</span>
                        <span>Reading Time: ${book.minutesRead} min</span>
                        <span>Difficulty: ${capitalizeFirstLetter(book.difficulty)}</span>
                    </div>
                `;
                
                listElement.appendChild(bookElement);
            });
        }
        
        // Helper function to capitalize the first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Show a notification
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification mb-2 p-3 rounded-lg shadow-md transition-opacity duration-500 opacity-0';
            
            // Set background color based on type
            if (type === 'success') {
                notification.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-800', 'dark:text-green-100');
            } else if (type === 'warning') {
                notification.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-800', 'dark:text-yellow-100');
            } else if (type === 'error') {
                notification.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-800', 'dark:text-red-100');
            } else if (type === 'enlightenment') {
                notification.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-800', 'dark:text-red-100');
                notification.innerHTML = `<div class="enlightenment-glow">${message}</div>`;
            } else {
                notification.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-800', 'dark:text-blue-100');
                notification.textContent = message;
            }
            
            if (type !== 'enlightenment') {
                notification.textContent = message;
            }
            
            // Add to notification area
            notificationArea.appendChild(notification);
            
            // Fade in
            setTimeout(() => {
                notification.classList.remove('opacity-0');
                notification.classList.add('opacity-100');
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('opacity-100');
                notification.classList.add('opacity-0');
                
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 3000);
        }
        
        // Calculate knowledge points for reading
        function calculateReadingKp(pages, minutes, difficulty) {
            let kpFromPages = pages * gameSettings.baseKpPerPage;
            let kpFromTime = minutes * gameSettings.baseKpPerMinute;
            
            // Apply difficulty multiplier
            let difficultyMultiplier = gameSettings.difficultyMultipliers[difficulty];
            let totalKp = (kpFromPages + kpFromTime) * difficultyMultiplier;
            
            // Apply reading efficiency permanent bonus if unlocked
            if (gameState.prestige.unlocked) {
                const readingEfficiencyBonus = gameState.prestige.permanentUpgrades.readingEfficiency.bonus;
                totalKp *= (1 + (readingEfficiencyBonus / 100));
            }
            
            // Apply knowledge repository bonus if built
            if (gameState.facilities.knowledgeRepository.built) {
                totalKp *= (1 + (gameState.facilities.knowledgeRepository.bonus / 100));
            }
            
            // Apply speed reading bonus if researched
            if (gameState.research.speedReading) {
                totalKp *= 1.25;
            }
            
            // Apply facility optimization bonus if researched
            if (gameState.research.facilityOptimization) {
                totalKp *= (1 + gameSettings.facilityOptimizationBonus);
            }
            
            // Apply resource production bonus if unlocked
            if (gameState.prestige.unlocked && gameState.prestige.permanentUpgrades.resourceProduction.bonus > 0) {
                totalKp *= (1 + (gameState.prestige.permanentUpgrades.resourceProduction.bonus / 100));
            }
            
            // Apply galaxy bonuses from active planets
            gameState.galaxy.activePlanets.forEach(planet => {
                if (planet.bonuses) {
                    planet.bonuses.forEach(bonus => {
                        // Apply kp_per_page bonus
                        if (bonus.type === 'kp_per_page') {
                            totalKp += kpFromPages * (bonus.value / 100);
                        }
                        
                        // Apply kp_per_minute bonus
                        if (bonus.type === 'kp_per_minute') {
                            totalKp += kpFromTime * (bonus.value / 100);
                        }
                    });
                }
            });
            
            return totalKp;
        }
        
        // Add experience points and check for level up
        function addExperience(amount) {
            // Apply permanent experience boost if unlocked
            if (gameState.prestige.unlocked) {
                const xpBoost = gameState.prestige.permanentUpgrades.experienceBoost.bonus;
                amount *= (1 + (xpBoost / 100));
            }
            
            // Apply academy complex bonus if built
            if (gameState.facilities.academyComplex.built) {
                amount *= 1.12; // 12% XP bonus (increased from 8%)
            }
            
            // Apply facility optimization bonus if researched
            if (gameState.research.facilityOptimization) {
                amount *= (1 + gameSettings.facilityOptimizationBonus);
            }
            
            // Apply galaxy bonuses from active planets
            gameState.galaxy.activePlanets.forEach(planet => {
                if (planet.bonuses) {
                    planet.bonuses.forEach(bonus => {
                        // Apply xp_gain bonus
                        if (bonus.type === 'xp_gain') {
                            amount *= (1 + (bonus.value / 100));
                        }
                    });
                }
            });
            
            gameState.player.experiencePoints += amount;
            
            // Check for level up
            if (gameState.player.experiencePoints >= gameState.player.experienceToNextLevel) {
                gameState.player.experiencePoints -= gameState.player.experienceToNextLevel;
                gameState.player.level += 1;
                gameState.player.experienceToNextLevel = Math.floor(gameState.player.experienceToNextLevel * 1.5);
                
                showNotification(`Level up! You are now level ${gameState.player.level}`, 'success');
                
                // Check for new unlocks
                checkUnlocks();
            }
        }
        
        // Resource generation timer
        function startResourceGeneration() {
            setInterval(() => {
                // Research Center - Research Points
                if (gameState.facilities.researchCenter.built) {
                    let rpGain = gameState.facilities.researchCenter.output / 2; // Divide by 2 as the interval is 30s
                    
                    // Apply facility optimization bonus if researched
                    if (gameState.research.facilityOptimization) {
                        rpGain *= (1 + gameSettings.facilityOptimizationBonus);
                    }
                    
                    // Apply resource production bonus if unlocked
                    if (gameState.prestige.unlocked && gameState.prestige.permanentUpgrades.resourceProduction.bonus > 0) {
                        rpGain *= (1 + (gameState.prestige.permanentUpgrades.resourceProduction.bonus / 100));
                    }
                    
                    // Apply automated collection bonus if researched
                    // For a full implementation, we'd track when the user was last active
                    
                    gameState.resources.researchPoints += rpGain;
                }
                
                // Apply passive resource generation from galaxy bonuses
                gameState.galaxy.activePlanets.forEach(planet => {
                    if (planet.bonuses) {
                        planet.bonuses.forEach(bonus => {
                            // Apply passive resource generation
                            if (bonus.type === 'passive_kp') {
                                gameState.resources.knowledgePoints += bonus.value / 2; // Divide by 2 as the interval is 30s
                            }
                            if (bonus.type === 'passive_rp') {
                                gameState.resources.researchPoints += bonus.value / 2; // Divide by 2 as the interval is 30s
                            }
                            if (bonus.type === 'passive_inf') {
                                gameState.resources.influence += bonus.value / 2; // Divide by 2 as the interval is 30s
                            }
                        });
                    }
                });
                
                updateUI();
            }, gameSettings.resourceInterval);
        }
        
        // Check for new unlocks based on game state
        function checkUnlocks() {
            // Check for Academy Complex unlock
            if (gameState.player.level >= gameState.facilities.academyComplex.prerequisites.playerLevel && 
                gameState.facilities.researchCenter.level >= gameState.facilities.academyComplex.prerequisites.researchCenterLevel) {
                const lockedTag = document.querySelector('#facility-academy-complex .absolute');
                if (lockedTag && !lockedTag.classList.contains('hidden')) {
                    lockedTag.classList.add('hidden');
                    document.getElementById('build-academy').textContent = `Build (${gameState.facilities.academyComplex.cost} KP, ${gameState.facilities.academyComplex.rpCost} RP)`;
                    document.getElementById('build-academy').classList.remove('bg-gray-200', 'text-gray-500');
                    document.getElementById('build-academy').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    
                    showNotification('Academy Complex unlocked! Build it to train specialists.', 'success');
                }
            }
            
            // Check for Observatory unlock
            if (gameState.player.level >= gameState.facilities.observatory.prerequisites.playerLevel && 
                gameState.stats.booksCompleted >= gameState.facilities.observatory.prerequisites.booksCompleted) {
                const lockedTag = document.querySelector('#facility-observatory .absolute');
                if (lockedTag && !lockedTag.classList.contains('hidden')) {
                    lockedTag.classList.add('hidden');
                    document.getElementById('build-observatory').textContent = `Build (${gameState.facilities.observatory.cost} KP, ${gameState.facilities.observatory.rpCost} RP)`;
                    document.getElementById('build-observatory').classList.remove('bg-gray-200', 'text-gray-500');
                    document.getElementById('build-observatory').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    
                    showNotification('Observatory unlocked! Build it to discover new books and explore the galaxy.', 'success');
                }
            }
            
            // Check for Virtual Library unlock
            if (gameState.player.level >= gameState.facilities.virtualLibrary.prerequisites.playerLevel && 
                gameState.facilities.knowledgeRepository.level >= gameState.facilities.virtualLibrary.prerequisites.knowledgeRepositoryLevel &&
                gameState.stats.booksCompleted >= gameState.facilities.virtualLibrary.prerequisites.booksCompleted) {
                const lockedTag = document.querySelector('#facility-virtual-library .absolute');
                if (lockedTag && !lockedTag.classList.contains('hidden')) {
                    lockedTag.classList.add('hidden');
                    document.getElementById('build-virtual-library').textContent = `Build (${gameState.facilities.virtualLibrary.cost} KP, ${gameState.facilities.virtualLibrary.rpCost} RP)`;
                    document.getElementById('build-virtual-library').classList.remove('bg-gray-200', 'text-gray-500');
                    document.getElementById('build-virtual-library').classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    
                    showNotification('Virtual Library unlocked! Build it for advanced analysis and passive resource generation.', 'success');
                }
            }
            
            // Check for Facility Optimization research unlock
            if (gameState.facilities.researchCenter.level >= 2 && !gameState.research.facilityOptimization) {
                const researchOptimizationBtn = document.getElementById('research-optimization');
                if (researchOptimizationBtn.classList.contains('bg-gray-200') && gameState.resources.researchPoints >= 200) {
                    researchOptimizationBtn.classList.remove('bg-gray-200', 'text-gray-500');
                    researchOptimizationBtn.classList.add('bg-primary', 'hover:bg-blue-700', 'text-white');
                    
                    showNotification('Facility Optimization research available! Research it to boost all facility output.', 'info');
                }
            }
            
            // Check for Stellar Cartography unlock when Observatory is built
            if (gameState.facilities.observatory.built && !gameState.research.stellarCartography &&
                document.getElementById('stellar-cartography-research').classList.contains('hidden')) {
                document.getElementById('stellar-cartography-research').classList.remove('hidden');
                showNotification('Stellar Cartography research available! Research it to explore the galaxy.', 'info');
            }
            
            // Check if Galaxy should be unlocked
            if (gameState.facilities.observatory.built && gameState.research.stellarCartography && !gameState.galaxy.unlocked) {
                gameState.galaxy.unlocked = true;
                showNotification('Galaxy exploration unlocked! Visit the Galaxy tab to explore star systems.', 'success');
                updateGalaxyUI();
            }
            
            // Check for Enlightenment Studies research unlock
            if (gameState.player.level >= gameSettings.prestigeRequirements.playerLevel && 
                gameState.stats.booksCompleted >= gameSettings.prestigeRequirements.booksCompleted && 
                !gameState.research.enlightenmentStudies) {
                
                // Make sure the research is visible in the UI
                const enlightenmentStudiesResearch = document.getElementById('enlightenment-studies-research');
                if (enlightenmentStudiesResearch && enlightenmentStudiesResearch.classList.contains('hidden')) {
                    enlightenmentStudiesResearch.classList.remove('hidden');
                    
                    showNotification('Enlightenment Studies research available! Research it to unlock the Prestige system.', 'enlightenment');
                }
            }
            
            // Check for achievements
            if (gameState.stats.booksCompleted >= 5 && document.querySelector('#bookworm-progress').textContent !== "5") {
                showNotification('Achievement unlocked: Bookworm!', 'success');
            }
            
            if (gameState.stats.pagesRead >= 1000 && document.querySelector('#prolific-progress').textContent !== "1000") {
                showNotification('Achievement unlocked: Prolific Reader!', 'success');
            }
        }
        
        // Export game save as Base64
        function exportGameSave() {
            try {
                const saveData = JSON.stringify(gameState);
                const base64Save = btoa(saveData);
                
                document.getElementById('export-save-text').value = base64Save;
                document.getElementById('save-export-modal').classList.remove('hidden');
                
                return base64Save;
            } catch (error) {
                showNotification('Error exporting save: ' + error.message, 'error');
                return null;
            }
        }
        
        // Import game save from Base64
        function importGameSave(base64Save) {
            try {
                const saveData = atob(base64Save);
                const parsedSave = JSON.parse(saveData);
                
                // Version check
                if (!parsedSave.version) {
                    showNotification('Invalid save data: no version information', 'error');
                    return false;
                }
                
                // Ensure custom genre structure exists
                if (!parsedSave.stats.genreDistribution.custom) {
                    parsedSave.stats.genreDistribution.custom = {};
                }
                
                // Ensure galaxy data structure exists
                if (!parsedSave.galaxy) {
                    parsedSave.galaxy = {
                        unlocked: false,
                        discoveredSystems: {},
                        currentCoordinates: { x: 0, y: 0 },
                        viewCenter: { x: 0, y: 0 },
                        explorationRange: 3,
                        zoomLevel: 1,
                        nextSystemCost: 25,
                        systemCosts: {
                            base: 25,
                            distanceMultiplier: 1.2
                        },
                        activePlanets: [],
                        activeExpedition: null,
                        stats: {
                            systemsDiscovered: 0,
                            outpostsEstablished: 0,
                            planetsColonized: 0,
                            expeditionsCompleted: 0,
                            rarePlanetsFound: 0
                        }
                    };
                }
                
                // Import the save
                Object.assign(gameState, parsedSave);
                
                // Check if Enlightenment is unlocked
                if (gameState.research.enlightenmentStudies) {
                    gameSettings.enlightenmentUnlocked = true;
                }
                
                updateUI();
                showNotification('Game progress imported successfully!', 'success');
                return true;
            } catch (error) {
                showNotification('Error importing save: ' + error.message, 'error');
                return false;
            }
        }
        
        // Reset the game
        function resetGame() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone!')) {
                // Reset game state to initial values
                gameState.player = {
                    level: 1,
                    experiencePoints: 0,
                    experienceToNextLevel: 100
                };
                
                gameState.resources = {
                    knowledgePoints: 50,
                    researchPoints: 0,
                    influence: 0
                };
                
                gameState.facilities = {
                    researchCenter: {
                        level: 0,
                        built: false,
                        output: 0,
                        cost: 50,
                        upgradeCost: 100
                    },
                    knowledgeRepository: {
                        level: 0,
                        built: false,
                        bonus: 0,
                        cost: 100,
                        rpCost: 20,
                        upgradeCost: 200,
                        upgradeRpCost: 40
                    },
                    academyComplex: {
                        level: 0,
                        built: false,
                        bonus: 0,
                        cost: 300,
                        rpCost: 100,
                        upgradeCost: 500,
                        upgradeRpCost: 150,
                        prerequisites: {
                            playerLevel: 3,
                            researchCenterLevel: 2
                        }
                    },
                    observatory: {
                        level: 0,
                        built: false,
                        bonus: 0,
                        cost: 200,
                        rpCost: 50,
                        upgradeCost: 350,
                        upgradeRpCost: 100,
                        prerequisites: {
                            playerLevel: 2,
                            booksCompleted: 5
                        }
                    },
                    virtualLibrary: {
                        level: 0,
                        built: false,
                        bonus: 0,
                        cost: 500,
                        rpCost: 200,
                        upgradeCost: 800,
                        upgradeRpCost: 300,
                        prerequisites: {
                            playerLevel: 4,
                            knowledgeRepositoryLevel: 3,
                            booksCompleted: 15
                        }
                    }
                };
                
                gameState.research = {
                    speedReading: false,
                    comprehensionAlgorithms: false,
                    advancedConstruction: false,
                    automatedCollection: false,
                    facilityOptimization: false,
                    enlightenmentStudies: false,
                    stellarCartography: false
                };
                
                gameState.stats = {
                    booksCompleted: 0,
                    pagesRead: 0,
                    minutesRead: 0,
                    totalKpGenerated: 0,
                    genreDistribution: {
                        'sci-fi': 0,
                        'fantasy': 0,
                        'non-fiction': 0,
                        'mystery': 0,
                        'history': 0,
                        'science': 0,
                        'biography': 0,
                        'custom': {}
                    }
                };
                
                gameState.currentBooks = [];
                
                // Reset prestige system
                gameState.prestige = {
                    unlocked: false,
                    level: 0,
                    enlightenmentPoints: 0,
                    totalEnlightenmentEarned: 0,
                    permanentUpgrades: {
                        resourceProduction: {
                            level: 0,
                            bonus: 0,
                            cost: 5,
                            increment: 10
                        },
                        startingResources: {
                            level: 0,
                            kpBonus: 0,
                            rpBonus: 0,
                            cost: 5,
                            kpIncrement: 25,
                            rpIncrement: 10
                        },
                        readingEfficiency: {
                            level: 0,
                            bonus: 0,
                            cost: 10,
                            increment: 15
                        },
                        experienceBoost: {
                            level: 0,
                            bonus: 0,
                            cost: 8,
                            increment: 12
                        },
                        autoResearch: {
                            level: 0,
                            cost: 15,
                            maxLevel: 5
                        },
                        facilityRetention: {
                            level: 0,
                            cost: 20,
                            maxLevel: 3
                        }
                    }
                };
                
                gameState.lifetimeStats = {
                    totalPrestiges: 0,
                    maxLevel: 1,
                    maxBooks: 0,
                    totalEnlightenmentPoints: 0
                };
                
                // Reset galaxy exploration system
                gameState.galaxy = {
                    unlocked: false,
                    discoveredSystems: {},
                    currentCoordinates: { x: 0, y: 0 },
                    viewCenter: { x: 0, y: 0 },
                    explorationRange: 3,
                    zoomLevel: 1,
                    nextSystemCost: 25,
                    systemCosts: {
                        base: 25,
                        distanceMultiplier: 1.2
                    },
                    activePlanets: [],
                    activeExpedition: null,
                    stats: {
                        systemsDiscovered: 0,
                        outpostsEstablished: 0,
                        planetsColonized: 0,
                        expeditionsCompleted: 0,
                        rarePlanetsFound: 0
                    }
                };
                
                // Reset game settings
                gameSettings.enlightenmentUnlocked = false;
                
                // Hide enlightenment elements
                document.getElementById('enlightenment-container').classList.add('hidden');
                document.getElementById('prestige-level-container').classList.add('hidden');
                document.getElementById('enlightenment-tab-li').classList.add('hidden');
                document.getElementById('prestige-stats-section').classList.add('hidden');
                document.getElementById('prestige-settings-section').classList.add('hidden');
                
                // Update UI
                updateUI();
                
                showNotification('Game has been reset to initial state', 'info');
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Log reading session
            document.getElementById('log-reading').addEventListener('click', () => {
                const title = document.getElementById('book-title').value.trim();
                const genre = document.getElementById('book-genre').value;
                const difficulty = document.getElementById('book-difficulty').value;
                const pages = parseInt(document.getElementById('pages-read').value);
                const minutes = parseInt(document.getElementById('reading-minutes').value);
                
                if (!title) {
                    showNotification('Please enter a book title.', 'error');
                    return;
                }
                
                if (isNaN(pages) || pages <= 0) {
                    showNotification('Please enter a valid number of pages.', 'error');
                    return;
                }
                
                if (isNaN(minutes) || minutes <= 0) {
                    showNotification('Please enter a valid number of minutes.', 'error');
                    return;
                }
                
                // Get custom genre if selected
                let customGenre = '';
                if (genre === 'custom') {
                    customGenre = document.getElementById('custom-genre').value.trim();
                    if (!customGenre) {
                        showNotification('Please enter a custom genre.', 'error');
                        return;
                    }
                }
                
                // Calculate KP gained
                const kpGained = calculateReadingKp(pages, minutes, difficulty);
                
                // Update game state
                gameState.resources.knowledgePoints += kpGained;
                gameState.stats.pagesRead += pages;
                gameState.stats.minutesRead += minutes;
                gameState.stats.totalKpGenerated += kpGained;
                
                // Add experience points (1 per page + 0.5 per minute)
                addExperience(pages + Math.floor(minutes / 2));
                
                // Check if book already exists in current books
                const existingBookIndex = gameState.currentBooks.findIndex(book => book.title.toLowerCase() === title.toLowerCase());
                
                if (existingBookIndex !== -1) {
                    // Update existing book
                    gameState.currentBooks[existingBookIndex].pagesRead += pages;
                    gameState.currentBooks[existingBookIndex].minutesRead += minutes;
                } else {
                    // Add new book
                    const newBook = {
                        title,
                        genre,
                        difficulty,
                        pagesRead: pages,
                        minutesRead: minutes
                    };
                    
                    // Add custom genre if applicable
                    if (genre === 'custom') {
                        newBook.customGenre = customGenre;
                    }
                    
                    gameState.currentBooks.push(newBook);
                }
                
                showNotification(`Reading logged! +${Math.floor(kpGained)} Knowledge Points`, 'success');
                updateUI();
            });
            
            // Complete book
            document.getElementById('complete-book').addEventListener('click', () => {
                const title = document.getElementById('book-title').value.trim();
                
                if (!title) {
                    showNotification('Please enter a book title.', 'error');
                    return;
                }
                
                // Check if book exists in current books
                const existingBookIndex = gameState.currentBooks.findIndex(book => book.title.toLowerCase() === title.toLowerCase());
                
                if (existingBookIndex === -1) {
                    showNotification('This book is not in your current reading list.', 'error');
                    return;
                }
                
                const completedBook = gameState.currentBooks[existingBookIndex];
                
                // Calculate completion bonus
                let completionBonus = completedBook.pagesRead * gameSettings.baseKpPerPage * gameSettings.completionBonus;
                
                // Apply comprehension algorithms bonus if researched
                if (gameState.research.comprehensionAlgorithms) {
                    completionBonus *= 1.2;
                }
                
                // Apply facility optimization bonus if researched
                if (gameState.research.facilityOptimization) {
                    completionBonus *= (1 + gameSettings.facilityOptimizationBonus);
                }
                
                // Apply resource production permanent bonus if unlocked
                if (gameState.prestige.unlocked && gameState.prestige.permanentUpgrades.resourceProduction.bonus > 0) {
                    completionBonus *= (1 + (gameState.prestige.permanentUpgrades.resourceProduction.bonus / 100));
                }
                
                // Apply galaxy bonuses from active planets
                gameState.galaxy.activePlanets.forEach(planet => {
                    if (planet.bonuses) {
                        planet.bonuses.forEach(bonus => {
                            // Apply completion_bonus
                            if (bonus.type === 'completion_bonus') {
                                completionBonus *= (1 + (bonus.value / 100));
                            }
                        });
                    }
                });
                
                // Update game state
                gameState.resources.knowledgePoints += completionBonus;
                gameState.stats.booksCompleted += 1;
                gameState.stats.totalKpGenerated += completionBonus;
                
                // Update genre distribution
                if (completedBook.genre === 'custom' && completedBook.customGenre) {
                    // Handle custom genre stats
                    if (!gameState.stats.genreDistribution.custom[completedBook.customGenre]) {
                        gameState.stats.genreDistribution.custom[completedBook.customGenre] = 0;
                    }
                    gameState.stats.genreDistribution.custom[completedBook.customGenre] += 1;
                } else {
                    // Handle standard genre stats
                    gameState.stats.genreDistribution[completedBook.genre] += 1;
                }
                
                // Add influence points based on diversity of reading
                let genreCount = 0;
                // Count standard genres
                for (const genre in gameState.stats.genreDistribution) {
                    if (genre !== 'custom' && gameState.stats.genreDistribution[genre] > 0) {
                        genreCount++;
                    }
                }
                // Count custom genres
                genreCount += Object.keys(gameState.stats.genreDistribution.custom).length;
                
                // More diverse reading = more influence
                const influenceGain = Math.min(5, genreCount);
                
                // Apply Observatory bonus if built
                let finalInfluenceGain = influenceGain;
                if (gameState.facilities.observatory.built) {
                    finalInfluenceGain *= 1.15; // 15% more influence (increased from 10%)
                }
                
                // Apply facility optimization bonus if researched
                if (gameState.research.facilityOptimization) {
                    finalInfluenceGain *= (1 + gameSettings.facilityOptimizationBonus);
                }
                
                // Apply resource production permanent bonus if unlocked
                if (gameState.prestige.unlocked && gameState.prestige.permanentUpgrades.resourceProduction.bonus > 0) {
                    finalInfluenceGain *= (1 + (gameState.prestige.permanentUpgrades.resourceProduction.bonus / 100));
                }
                
                // Apply galaxy bonuses from active planets
                gameState.galaxy.activePlanets.forEach(planet => {
                    if (planet.bonuses) {
                        planet.bonuses.forEach(bonus => {
                            // Apply influence_gain bonus
                            if (bonus.type === 'influence_gain') {
                                finalInfluenceGain *= (1 + (bonus.value / 100));
                            }
                        });
                    }
                });
                
                gameState.resources.influence += finalInfluenceGain;
                
                // Add experience for book completion (5 * level)
                addExperience(5 * gameState.player.level);
                
                // Remove book from current books
                gameState.currentBooks.splice(existingBookIndex, 1);
                
                showNotification(`Book completed! +${Math.floor(completionBonus)} Knowledge Points, +${Math.floor(finalInfluenceGain)} Influence`, 'success');
                updateUI();
                
                // Check if Enlightenment Studies should be unlocked
                if (gameState.player.level >= gameSettings.prestigeRequirements.playerLevel && 
                    gameState.stats.booksCompleted >= gameSettings.prestigeRequirements.booksCompleted) {
                    checkUnlocks();
                }
            });
            
            // Build Research Center
            document.getElementById('build-research-center').addEventListener('click', () => {
                if (gameState.resources.knowledgePoints < gameState.facilities.researchCenter.cost) {
                    showNotification('Not enough Knowledge Points to build.', 'error');
                    return;
                }
                
                gameState.resources.knowledgePoints -= gameState.facilities.researchCenter.cost;
                gameState.facilities.researchCenter.built = true;
                gameState.facilities.researchCenter.level = 1;
                gameState.facilities.researchCenter.output = 3; // Increased from 2 to compensate for adjacency removal
                gameState.facilities.researchCenter.upgradeCost = 100;
                
                showNotification('Research Center built! You now generate Research Points over time.', 'success');
                updateUI();
            });
            
            // Upgrade Research Center
            document.getElementById('upgrade-research-center').addEventListener('click', () => {
                if (gameState.resources.knowledgePoints < gameState.facilities.researchCenter.upgradeCost) {
                    showNotification('Not enough Knowledge Points to upgrade.', 'error');
                    return;
                }
                
                gameState.resources.knowledgePoints -= gameState.facilities.researchCenter.upgradeCost;
                gameState.facilities.researchCenter.level += 1;
                gameState.facilities.researchCenter.output += 3; // Increased from 2 to compensate for adjacency removal
                gameState.facilities.researchCenter.upgradeCost = Math.floor(gameState.facilities.researchCenter.upgradeCost * 1.5);
                
                showNotification(`Research Center upgraded to level ${gameState.facilities.researchCenter.level}!`, 'success');
                updateUI();
                
                // Check for new unlocks
                checkUnlocks();
            });
            
            // Build Knowledge Repository
            document.getElementById('build-repository').addEventListener('click', () => {
                if (gameState.resources.knowledgePoints < gameState.facilities.knowledgeRepository.cost) {
                    showNotification('Not enough Knowledge Points to build.', 'error');
                    return;
                }
                
                if (gameState.resources.researchPoints < gameState.facilities.knowledgeRepository.rpCost) {
                    showNotification('Not enough Research Points to build.', 'error');
                    return;
                }
                
                gameState.resources.knowledgePoints -= gameState.facilities.knowledgeRepository.cost;
                gameState.resources.researchPoints -= gameState.facilities.knowledgeRepository.rpCost;
                gameState.facilities.knowledgeRepository.built = true;
                gameState.facilities.knowledgeRepository.level = 1;
                gameState.facilities.knowledgeRepository.bonus = 15; // Increased from 10 to compensate for adjacency removal
                
                showNotification('Knowledge Repository built! You now gain 15% more Knowledge Points from reading.', 'success');
                updateUI();
            });
            
            // Upgrade Knowledge Repository
            document.getElementById('upgrade-repository').addEventListener('click', () => {
                if (gameState.resources.knowledgePoints < gameState.facilities.knowledgeRepository.upgradeCost) {
                    showNotification('Not enough Knowledge Points to upgrade.', 'error');
                    return;
                }
                
                if (gameState.resources.researchPoints < gameState.facilities.knowledgeRepository.upgradeRpCost) {
                    showNotification('Not enough Research Points to upgrade.', 'error');
                    return;
                }
                
                gameState.resources.knowledgePoints -= gameState.facilities.knowledgeRepository.upgradeCost;
                gameState.resources.researchPoints -= gameState.facilities.knowledgeRepository.upgradeRpCost;
                gameState.facilities.knowledgeRepository.level += 1;
                gameState.facilities.knowledgeRepository.bonus += 15; // Increased from 10 to compensate for adjacency removal
                gameState.facilities.knowledgeRepository.upgradeCost = Math.floor(gameState.facilities.knowledgeRepository.upgradeCost * 1.5);
                gameState.facilities.knowledgeRepository.upgradeRpCost = Math.floor(gameState.facilities.knowledgeRepository.upgradeRpCost * 1.5);
                
                showNotification(`Knowledge Repository upgraded to level ${gameState.facilities.knowledgeRepository.level}!`, 'success');
                updateUI();
                
                // Check for new unlocks
                checkUnlocks();
            });
            
            // Build Academy Complex
            document.getElementById('build-academy').addEventListener('click', () => {
                // Check if button is in locked state
                if (document.getElementById('build-academy').textContent === 'Locked') {
                    return;
                }
                
                if (gameState.resources.knowledgePoints < gameState.facilities.academyComplex.cost) {
                    showNotification('Not enough Knowledge Points to build.', 'error');
                    return;
                }
                
                if (gameState.resources.researchPoints < gameState.facilities.academyComplex.rpCost) {
                    showNotification('Not enough Research Points to build.', 'error');
                    return;
                }
                
                gameState.resources.knowledgePoints -= gameState.facilities.academyComplex.cost;
                gameState.resources.researchPoints -= gameState.facilities.academyComplex.rpCost;
                gameState.facilities.academyComplex.built = true;
                gameState.facilities.academyComplex.level = 1;
                
                showNotification('Academy Complex built! You now gain 12% more XP from reading.', 'success');
                updateUI();
            });
            
            // Build Observatory
            document.getElementById('build-observatory').addEventListener('click', () => {
                // Check if button is in locked state
                if (document.getElementById('build-observatory').textContent === 'Locked') {
                    return;
                }
                
                if (gameState.resources.knowledgePoints < gameState.facilities.observatory.cost) {
                    showNotification('Not enough Knowledge Points to build.', 'error');
                    return;
                }
                
                if (gameState.resources.researchPoints < gameState.facilities.observatory.rpCost) {
                    showNotification('Not enough Research Points to build.', 'error');
                    return;
                }
                
                gameState.resources.knowledgePoints -= gameState.facilities.observatory.cost;
                gameState.resources.researchPoints -= gameState.facilities.observatory.rpCost;
                gameState.facilities.observatory.built = true;
                gameState.facilities.observatory.level = 1;
                
                showNotification('Observatory built! You now gain 15% more Influence from completing books.', 'success');
                updateUI();
                
                // Check for Stellar Cartography research unlock
                checkUnlocks();
            });
            
            // Build Virtual Library
            document.getElementById('build-virtual-library').addEventListener('click', () => {
                // Check if button is in locked state
                if (document.getElementById('build-virtual-library').textContent === 'Locked') {
                    return;
                }
                
                if (gameState.resources.knowledgePoints < gameState.facilities.virtualLibrary.cost) {
                    showNotification('Not enough Knowledge Points to build.', 'error');
                    return;
                }
                
                if (gameState.resources.researchPoints < gameState.facilities.virtualLibrary.rpCost) {
                    showNotification('Not enough Research Points to build.', 'error');
                    return;
                }
                
                gameState.resources.knowledgePoints -= gameState.facilities.virtualLibrary.cost;
                gameState.resources.researchPoints -= gameState.facilities.virtualLibrary.rpCost;
                gameState.facilities.virtualLibrary.built = true;
                gameState.facilities.virtualLibrary.level = 1;
                
                showNotification('Virtual Library built! You now generate resources passively based on books read.', 'success');
                updateUI();
            });
            
            // Research - Speed Reading
            document.getElementById('research-speed-reading').addEventListener('click', () => {
                if (gameState.research.speedReading) {
                    return;
                }
                
                if (gameState.resources.researchPoints < 50) {
                    showNotification('Not enough Research Points to research.', 'error');
                    return;
                }
                
                gameState.resources.researchPoints -= 50;
                gameState.research.speedReading = true;
                
                showNotification('Speed Reading researched! You now gain 25% more Knowledge Points from reading time.', 'success');
                updateUI();
            });
            
            // Research - Comprehension Algorithms
            document.getElementById('research-comprehension').addEventListener('click', () => {
                if (gameState.research.comprehensionAlgorithms) {
                    return;
                }
                
                if (gameState.resources.researchPoints < 75) {
                    showNotification('Not enough Research Points to research.', 'error');
                    return;
                }
                
                gameState.resources.researchPoints -= 75;
                gameState.research.comprehensionAlgorithms = true;
                
                showNotification('Comprehension Algorithms researched! You now gain 20% more Knowledge Points for completing books.', 'success');
                updateUI();
            });
            
            // Research - Advanced Construction
            document.getElementById('research-construction').addEventListener('click', () => {
                if (gameState.research.advancedConstruction) {
                    return;
                }
                
                if (gameState.resources.researchPoints < 100) {
                    showNotification('Not enough Research Points to research.', 'error');
                    return;
                }
                
                gameState.resources.researchPoints -= 100;
                gameState.research.advancedConstruction = true;
                
                // Apply discount to current costs
                gameState.facilities.researchCenter.upgradeCost = Math.floor(gameState.facilities.researchCenter.upgradeCost * 0.85);
                gameState.facilities.knowledgeRepository.upgradeCost = Math.floor(gameState.facilities.knowledgeRepository.upgradeCost * 0.85);
                gameState.facilities.academyComplex.cost = Math.floor(gameState.facilities.academyComplex.cost * 0.85);
                gameState.facilities.observatory.cost = Math.floor(gameState.facilities.observatory.cost * 0.85);
                gameState.facilities.virtualLibrary.cost = Math.floor(gameState.facilities.virtualLibrary.cost * 0.85);
                
                showNotification('Advanced Construction researched! Facility building and upgrade costs reduced by 15%.', 'success');
                updateUI();
            });
            
            // Research - Automated Collection
            document.getElementById('research-automation').addEventListener('click', () => {
                if (gameState.research.automatedCollection) {
                    return;
                }
                
                if (gameState.resources.researchPoints < 150) {
                    showNotification('Not enough Research Points to research.', 'error');
                    return;
                }
                
                gameState.resources.researchPoints -= 150;
                gameState.research.automatedCollection = true;
                
                showNotification('Automated Collection researched! You now gain 50% more resources while offline.', 'success');
                updateUI();
            });
            
            // Research - Facility Optimization
            document.getElementById('research-optimization').addEventListener('click', () => {
                if (gameState.research.facilityOptimization) {
                    return;
                }
                
                // Check requirements
                if (gameState.facilities.researchCenter.level < 2) {
                    showNotification('Research Center Level 2 required for this research.', 'error');
                    return;
                }
                
                if (gameState.resources.researchPoints < 200) {
                    showNotification('Not enough Research Points to research.', 'error');
                    return;
                }
                
                gameState.resources.researchPoints -= 200;
                gameState.research.facilityOptimization = true;
                
                showNotification('Facility Optimization researched! All facility outputs and bonuses increased by 20%.', 'success');
                updateUI();
            });
            
            // Research - Stellar Cartography
            document.getElementById('research-cartography').addEventListener('click', () => {
                if (gameState.research.stellarCartography) {
                    return;
                }
                
                // Check requirements
                if (!gameState.facilities.observatory.built) {
                    showNotification('Observatory required for this research.', 'error');
                    return;
                }
                
                if (gameState.resources.researchPoints < 150) {
                    showNotification('Not enough Research Points to research.', 'error');
                    return;
                }
                
                gameState.resources.researchPoints -= 150;
                gameState.research.stellarCartography = true;
                gameState.galaxy.unlocked = true;
                
                showNotification('Stellar Cartography researched! You can now explore the galaxy in the Galaxy tab.', 'success');
                updateUI();
            });
            
            // Research - Enlightenment Studies
            if (document.getElementById('research-enlightenment')) {
                document.getElementById('research-enlightenment').addEventListener('click', () => {
                    if (gameState.research.enlightenmentStudies) {
                        return;
                    }
                    
                    // Check requirements
                    if (gameState.player.level < gameSettings.prestigeRequirements.playerLevel ||
                        gameState.stats.booksCompleted < gameSettings.prestigeRequirements.booksCompleted) {
                        showNotification(`Not qualified for Enlightenment. Reach level ${gameSettings.prestigeRequirements.playerLevel} and complete ${gameSettings.prestigeRequirements.booksCompleted} books.`, 'error');
                        return;
                    }
                    
                    if (gameState.resources.researchPoints < 500) {
                        showNotification('Not enough Research Points to research.', 'error');
                        return;
                    }
                    
                    gameState.resources.researchPoints -= 500;
                    gameState.research.enlightenmentStudies = true;
                    gameState.prestige.unlocked = true;
                    gameSettings.enlightenmentUnlocked = true;
                    
                    // Show enlightenment tab and resources
                    document.getElementById('enlightenment-container').classList.remove('hidden');
                    document.getElementById('prestige-level-container').classList.remove('hidden');
                    document.getElementById('enlightenment-tab-li').classList.remove('hidden');
                    document.getElementById('prestige-stats-section').classList.remove('hidden');
                    document.getElementById('prestige-settings-section').classList.remove('hidden');
                    
                    showNotification('Enlightenment Studies researched! You can now ascend to gain permanent bonuses.', 'enlightenment');
                    updateUI();
                });
            }
            
            // Galaxy discovery modal close button
            document.getElementById('close-discovery-modal').addEventListener('click', () => {
                document.getElementById('discovery-modal').classList.add('hidden');
            });
            
            // Enlightenment Permanent Upgrades
            
            // Resource Production
            document.getElementById('upgrade-resource-production').addEventListener('click', () => {
                const upgrade = gameState.prestige.permanentUpgrades.resourceProduction;
                
                if (gameState.prestige.enlightenmentPoints < upgrade.cost) {
                    showNotification('Not enough Enlightenment Points for this upgrade.', 'error');
                    return;
                }
                
                gameState.prestige.enlightenmentPoints -= upgrade.cost;
                upgrade.level += 1;
                upgrade.bonus += upgrade.increment;
                upgrade.cost = Math.floor(upgrade.cost * 1.5);
                
                showNotification(`Resource Production upgraded to +${upgrade.bonus}%!`, 'enlightenment');
                updateEnlightenmentUI();
            });
            
            // Starting Resources
            document.getElementById('upgrade-starting-resources').addEventListener('click', () => {
                const upgrade = gameState.prestige.permanentUpgrades.startingResources;
                
                if (gameState.prestige.enlightenmentPoints < upgrade.cost) {
                    showNotification('Not enough Enlightenment Points for this upgrade.', 'error');
                    return;
                }
                
                gameState.prestige.enlightenmentPoints -= upgrade.cost;
                upgrade.level += 1;
                upgrade.kpBonus += upgrade.kpIncrement;
                upgrade.rpBonus += upgrade.rpIncrement;
                upgrade.cost = Math.floor(upgrade.cost * 1.5);
                
                showNotification(`Starting Resources upgraded to +${upgrade.kpBonus} KP / +${upgrade.rpBonus} RP!`, 'enlightenment');
                updateEnlightenmentUI();
            });
            
            // Reading Efficiency
            document.getElementById('upgrade-reading-efficiency').addEventListener('click', () => {
                const upgrade = gameState.prestige.permanentUpgrades.readingEfficiency;
                
                if (gameState.prestige.enlightenmentPoints < upgrade.cost) {
                    showNotification('Not enough Enlightenment Points for this upgrade.', 'error');
                    return;
                }
                
                gameState.prestige.enlightenmentPoints -= upgrade.cost;
                upgrade.level += 1;
                upgrade.bonus += upgrade.increment;
                upgrade.cost = Math.floor(upgrade.cost * 1.5);
                
                showNotification(`Reading Efficiency upgraded to +${upgrade.bonus}%!`, 'enlightenment');
                updateEnlightenmentUI();
            });
            
            // Experience Boost
            document.getElementById('upgrade-experience-boost').addEventListener('click', () => {
                const upgrade = gameState.prestige.permanentUpgrades.experienceBoost;
                
                if (gameState.prestige.enlightenmentPoints < upgrade.cost) {
                    showNotification('Not enough Enlightenment Points for this upgrade.', 'error');
                    return;
                }
                
                gameState.prestige.enlightenmentPoints -= upgrade.cost;
                upgrade.level += 1;
                upgrade.bonus += upgrade.increment;
                upgrade.cost = Math.floor(upgrade.cost * 1.5);
                
                showNotification(`Experience Boost upgraded to +${upgrade.bonus}%!`, 'enlightenment');
                updateEnlightenmentUI();
            });
            
            // Auto Research
            document.getElementById('upgrade-auto-research').addEventListener('click', () => {
                const upgrade = gameState.prestige.permanentUpgrades.autoResearch;
                
                if (upgrade.level >= upgrade.maxLevel) {
                    showNotification('Auto Research is already at maximum level.', 'error');
                    return;
                }
                
                if (gameState.prestige.enlightenmentPoints < upgrade.cost) {
                    showNotification('Not enough Enlightenment Points for this upgrade.', 'error');
                    return;
                }
                
                gameState.prestige.enlightenmentPoints -= upgrade.cost;
                upgrade.level += 1;
                upgrade.cost = Math.floor(upgrade.cost * 1.6);
                
                const researchName = getNextAutoResearch(upgrade.level - 1);
                showNotification(`Auto Research upgraded! ${researchName} will now be automatically researched on prestige.`, 'enlightenment');
                updateEnlightenmentUI();
            });
            
            // Facility Retention
            document.getElementById('upgrade-facility-retention').addEventListener('click', () => {
                const upgrade = gameState.prestige.permanentUpgrades.facilityRetention;
                
                if (upgrade.level >= upgrade.maxLevel) {
                    showNotification('Facility Retention is already at maximum level.', 'error');
                    return;
                }
                
                if (gameState.prestige.enlightenmentPoints < upgrade.cost) {
                    showNotification('Not enough Enlightenment Points for this upgrade.', 'error');
                    return;
                }
                
                gameState.prestige.enlightenmentPoints -= upgrade.cost;
                upgrade.level += 1;
                upgrade.cost = Math.floor(upgrade.cost * 1.75);
                
                let facilityName = "";
                if (upgrade.level === 1) facilityName = "Research Center";
                else if (upgrade.level === 2) facilityName = "Knowledge Repository";
                else if (upgrade.level === 3) facilityName = "Observatory";
                
                showNotification(`Facility Retention upgraded! ${facilityName} will now be retained after prestige.`, 'enlightenment');
                updateEnlightenmentUI();
            });
            
            // Prestige/Ascension
            document.getElementById('prestige-button').addEventListener('click', () => {
                if (!gameState.prestige.unlocked) {
                    showNotification('You need to research Enlightenment Studies first.', 'error');
                    return;
                }
                
                // Open confirmation modal
                document.getElementById('ascension-modal').classList.remove('hidden');
                updateEpPreview();
            });
            
            // Ascend Button in Enlightenment Tab
            document.getElementById('ascend-button').addEventListener('click', () => {
                if (!gameState.prestige.unlocked) {
                    showNotification('You need to research Enlightenment Studies first.', 'error');
                    return;
                }
                
                // Open confirmation modal
                document.getElementById('ascension-modal').classList.remove('hidden');
                updateEpPreview();
            });
            
            // Confirm Ascension
            document.getElementById('confirm-ascension').addEventListener('click', () => {
                document.getElementById('ascension-modal').classList.add('hidden');
                performAscension();
            });
            
            // Cancel Ascension
            document.getElementById('cancel-ascension').addEventListener('click', () => {
                document.getElementById('ascension-modal').classList.add('hidden');
            });
            
            // Save/Load Game
            document.getElementById('export-save').addEventListener('click', () => {
                exportGameSave();
            });
            
            // Import Save
            document.getElementById('import-save').addEventListener('click', () => {
                const saveData = document.getElementById('import-save-data').value.trim();
                
                if (!saveData) {
                    showNotification('Please enter save data to import.', 'error');
                    return;
                }
                
                importGameSave(saveData);
            });
            
            // Copy Save to Clipboard
            document.getElementById('copy-save').addEventListener('click', () => {
                const saveData = exportGameSave();
                
                if (saveData) {
                    navigator.clipboard.writeText(saveData)
                        .then(() => {
                            showNotification('Save data copied to clipboard!', 'success');
                        })
                        .catch(err => {
                            showNotification('Error copying to clipboard: ' + err, 'error');
                        });
                }
            });
            
            // Copy Save from Modal to Clipboard
            document.getElementById('copy-save-modal').addEventListener('click', () => {
                const saveText = document.getElementById('export-save-text');
                
                saveText.select();
                navigator.clipboard.writeText(saveText.value)
                    .then(() => {
                        showNotification('Save data copied to clipboard!', 'success');
                    })
                    .catch(err => {
                        showNotification('Error copying to clipboard: ' + err, 'error');
                    });
            });
            
            // Close Export Modal
            document.getElementById('close-export-modal').addEventListener('click', () => {
                document.getElementById('save-export-modal').classList.add('hidden');
            });
            
            // Reset Game
            document.getElementById('reset-game').addEventListener('click', resetGame);
            
            // Define upgrade functions
            window.upgradeAcademy = function() {
                if (gameState.resources.knowledgePoints < gameState.facilities.academyComplex.upgradeCost ||
                    gameState.resources.researchPoints < gameState.facilities.academyComplex.upgradeRpCost) {
                    showNotification('Not enough resources to upgrade.', 'error');
                    return;
                }
                
                gameState.resources.knowledgePoints -= gameState.facilities.academyComplex.upgradeCost;
                gameState.resources.researchPoints -= gameState.facilities.academyComplex.upgradeRpCost;
                gameState.facilities.academyComplex.level += 1;
                gameState.facilities.academyComplex.upgradeCost = Math.floor(gameState.facilities.academyComplex.upgradeCost * 1.5);
                gameState.facilities.academyComplex.upgradeRpCost = Math.floor(gameState.facilities.academyComplex.upgradeRpCost * 1.5);
                
                showNotification(`Academy Complex upgraded to level ${gameState.facilities.academyComplex.level}!`, 'success');
                updateUI();
            };
            
            window.upgradeObservatory = function() {
                if (gameState.resources.knowledgePoints < gameState.facilities.observatory.upgradeCost ||
                    gameState.resources.researchPoints < gameState.facilities.observatory.upgradeRpCost) {
                    showNotification('Not enough resources to upgrade.', 'error');
                    return;
                }
                
                gameState.resources.knowledgePoints -= gameState.facilities.observatory.upgradeCost;
                gameState.resources.researchPoints -= gameState.facilities.observatory.upgradeRpCost;
                gameState.facilities.observatory.level += 1;
                gameState.facilities.observatory.upgradeCost = Math.floor(gameState.facilities.observatory.upgradeCost * 1.5);
                gameState.facilities.observatory.upgradeRpCost = Math.floor(gameState.facilities.observatory.upgradeRpCost * 1.5);
                
                // Increase exploration range by 1 for each level after the first
                if (gameState.galaxy.unlocked) {
                    gameState.galaxy.explorationRange += 1;
                }
                
                showNotification(`Observatory upgraded to level ${gameState.facilities.observatory.level}!`, 'success');
                updateUI();
            };
            
            window.upgradeVirtualLibrary = function() {
                if (gameState.resources.knowledgePoints < gameState.facilities.virtualLibrary.upgradeCost ||
                    gameState.resources.researchPoints < gameState.facilities.virtualLibrary.upgradeRpCost) {
                    showNotification('Not enough resources to upgrade.', 'error');
                    return;
                }
                
                gameState.resources.knowledgePoints -= gameState.facilities.virtualLibrary.upgradeCost;
                gameState.resources.researchPoints -= gameState.facilities.virtualLibrary.upgradeRpCost;
                gameState.facilities.virtualLibrary.level += 1;
                gameState.facilities.virtualLibrary.upgradeCost = Math.floor(gameState.facilities.virtualLibrary.upgradeCost * 1.5);
                gameState.facilities.virtualLibrary.upgradeRpCost = Math.floor(gameState.facilities.virtualLibrary.upgradeRpCost * 1.5);
                
                showNotification(`Virtual Library upgraded to level ${gameState.facilities.virtualLibrary.level}!`, 'success');
                updateUI();
            };
        });
        
        // Initialize the game
        function initGame() {
            // Initial UI update
            updateUI();
            
            // Start resource generation
            startResourceGeneration();
            
            // Check for dark mode
            checkDarkMode();
            
            // Show welcome notification
            showNotification('Welcome to Stellar Bibliophile v1.4.0! Track your reading and build your knowledge empire.', 'info');
        }
        
        // Start the game
        initGame();
    </script>
</body>
</html>
